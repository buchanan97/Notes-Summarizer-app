{% extends "layout.html" %}
{% block title %}Search | Notes Summarizer{% endblock %}

{% block content %}
<div class="search-page-container">
    <header class="search-header">
        <h1>Search Your Notes</h1>
        <div class="header-actions">
            {% if current_user.is_authenticated %}
                <span class="user-greeting">Hello, {{ current_user.username }}!</span>
                <a href="{{ url_for('main.logout_user_route') }}" class="logout-btn">Logout</a>
            {% else %}
                <span class="user-status">Not Logged In (<a href="{{ url_for('main.login') }}" class="login-btn">Login as Testuser</a>)</span>
            {% endif %}
        </div>
    </header>

    <main class="search-main">
        <section class="search-form-section">
            <form id="search-form">
                <input type="text" id="query" name="query" placeholder="Enter your search query..." required>
                <button type="submit" class="search-submit-btn">Search</button>
            </form>
        </section>

        <section class="recent-searches-section">
            <h2>Recent Searches</h2>
            {% if recent_searches %}
                <ul class="recent-searches-list">
                    {% for search in recent_searches %}
                        <li>{{ search.query_text }} ({{ search.timestamp.strftime('%Y-%m-%d %H:%M') }})</li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="no-recent-searches">No recent searches.</p>
            {% endif %}
        </section>

        <section class="search-results-section">
            <h2>Search Results</h2>
            <div id="search-results" class="results-display">
                <p class="initial-message">Your search results will appear here.</p>
            </div>
        </section>
    </main>
</div>

<script>
    // Define the base URL for viewing documents once, using Jinja2
    // IMPORTANT: 'doc_filename' matches the route parameter in routes.py
    const viewDocBaseUrl = "{{ url_for('main.view_doc', doc_filename='DOC_ID_PLACEHOLDER') }}";

    document.getElementById('search-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const query = document.getElementById('query').value;
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = '<p class="loading-message">Searching...</p>';

        console.log("Search initiated for query:", query);

        try {
            const response = await fetch('{{ url_for('main.perform_search_api') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `query=${encodeURIComponent(query)}`
            });

            console.log("Response status:", response.status);

            if (!response.ok) {
                const errorData = await response.json();
                resultsDiv.innerHTML = `<p class="error-message">Error: ${errorData.error || response.statusText}</p>`;
                console.error("Backend error response:", errorData);
                return;
            }

            const { results, query: returnedQuery } = await response.json();
            console.log("Data received from backend:", { results, returnedQuery });
            resultsDiv.innerHTML = '';

            if (results.length === 0) {
                resultsDiv.innerHTML = `<p class="no-results">No results found for "${returnedQuery}". Try another query.</p>`;
                console.log("No results found.");
            } else {
                console.log("Processing", results.length, "results...");
                results.forEach(result => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';

                    const docUrl = viewDocBaseUrl.replace('DOC_ID_PLACEHOLDER', encodeURIComponent(result.filename));

                    // Log the content of each result object before inserting it
                    console.log("Result object:", result);
                    console.log("Display Filename:", result.display_filename);
                    console.log("Snippet:", result.snippet); // <--- THIS IS THE CORRECTED CONSOLE LOG

                    resultCard.innerHTML = `
                        <div class="card-content">
                            <div class="card-text">
                                <h3 class="doc-title">${result.display_filename} (Score: ${result.score})</h3>
                                <p class="doc-source">Source: ${result.source || "Textbook"}</p>
                                <p class="doc-snippet">${result.snippet}</p> 
                            </div>
                            <div class="card-action">
                                <button class="read-btn" onclick="window.location.href='${docUrl}'">
                                    Read More
                                </button>
                            </div>
                        </div>
                    `;
                    resultsDiv.appendChild(resultCard);
                });
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p class="error-message">An unexpected error occurred: ${error.message}</p>`;
            console.error('Fetch error:', error);
        }
    });
</script>
{% endblock %}