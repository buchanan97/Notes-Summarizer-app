{% extends "layout.html" %}
{% block title %}Search | Notes Summarizer{% endblock %}

{% block content %}
<div class="search-page-container">

    <main class="search-main">
        <section class="search-form-section">
            <form id="search-form" class="search-form-inline" onsubmit="return false;">
                <input type="text" id="query" name="query" placeholder="Search for algorithms, data structures, ML concepts..." required>
            </form>
        </section>

        <section class="recent-searches-section">
            <h2>Recent Searches</h2>
            {% if recent_searches %}
                <div class="recent-searches-tags">
                    {% for search in recent_searches %}
                        <span class="search-tag" onclick="document.getElementById('query').value='{{ search.query_text }}'; document.getElementById('search-form').requestSubmit();">
                            {{ search.query_text }}
                        </span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-recent-searches">No recent searches.</p>
            {% endif %}
        </section>

        <section class="search-results-section">
            <h2>Search Results</h2>
            <div id="search-results" class="results-display">
                <p class="initial-message">Your search results will appear here.</p>
            </div>
        </section>
    </main>
</div>

<script>
    const viewDocBaseUrl = "{{ url_for('main.view_doc', doc_filename='DOC_ID_PLACEHOLDER') }}";

    document.getElementById('search-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const query = document.getElementById('query').value;
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = '<p class="loading-message">Searching...</p>';

        try {
            const response = await fetch('{{ url_for("main.perform_search_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `query=${encodeURIComponent(query)}`
            });

            if (!response.ok) {
                const errorData = await response.json();
                resultsDiv.innerHTML = `<p class="error-message">Error: ${errorData.error || response.statusText}</p>`;
                return;
            }

            const { results, query: returnedQuery } = await response.json();
            resultsDiv.innerHTML = '';

            if (results.length === 0) {
                resultsDiv.innerHTML = `<p class="no-results">No results found for "${returnedQuery}". Try another query.</p>`;
            } else {
                results.forEach(result => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';

                    const scoreVal = result.score ? parseFloat(result.score) : 0;
                    const displayScore = !isNaN(scoreVal) ? scoreVal.toFixed(4) : "0.0000";

                    const docUrl = viewDocBaseUrl.replace('DOC_ID_PLACEHOLDER', encodeURIComponent(result.filename));

                    resultCard.innerHTML = `
                        <div class="card-content">
                            <div class="card-text">
                                <h3 class="doc-title">${result.display_filename} (Score: ${displayScore})</h3>
                                <p class="doc-source">
                                    <img src="/static/assets/book_icon.svg" class="source-icon" alt="Icon">
                                    Source: ${result.source}
                                </p>
                                <p class="doc-snippet">${result.snippet || "No preview summary available."}</p> 
                            </div>
                        </div>
                    `;
                    resultsDiv.appendChild(resultCard);
                }); 
            }
        } catch (error) {
            resultsDiv.innerHTML = `<p class="error-message">An unexpected error occurred: ${error.message}</p>`;
        }
    }); 
</script>
{% endblock %}