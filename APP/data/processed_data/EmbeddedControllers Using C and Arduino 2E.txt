embedded controllersembedded controller using c arduino c arduino james fiorejames fioreembedded controller controller using c arduino james fiore version october embedded controller embedded controller using c arduino james fiore copyright james fiore released term creative common license work freely redistributable use attribution published james fiore dissident information feedback contact james fiore professor emeritus oer jfiore latest revision related title link low cost print version mirror site youtube channel electronics professor fiore cover art author embedded controller text designed introduce expand material related c programming language embedded controller specifically arduino development associated atmel atmega microcontrollers intended fit time constraint typical credit hour course electrical engineering technology computer engineering technology program fit need course computer science text doe attempt cover aspect c language arduino atmel vr microcontrollers section deal c language assumed student relative newcomer c language experience high level language example python mean concept conditionals iteration familiar student running fairly quickly arduino development environment examined unlike myriad arduino book available text doe simply rely arduino library convenient library far efficient way programming board chapter examine library source code s hood generic approach mean easier student use processor development system instead tightly tied platform atmel schematic data table derived published version atmel documentation http serf final word operation performance interested party familiar companion laboratory manual accompany text oer open educational resource laboratory manual series include computer programming python science sound oer text laboratory manual available operational amplifier linear integrated circuit semiconductor device dc electrical circuit analysis ac electrical circuit analysis check web site latest version note author text designed abet accredited aa program electrical engineering technology specifically used second year embedded controller course indebted student worker mvcc family support encouragement project possible seek traditional publisher work supporter contributor freeware shareware computer software decided instead release using creative common license encourage make use manual work build add effort appreciate notification thing big don t trust want got ta small peter gabriel embedded controller controller content course introduction c memory organization c language basic c language basic ii c storage type scope c array string c conditionals looping c pointer address c table c structure c linked list c memory c file c command line argument embedded programming hardware architecture avr atmega overview bit piece includes defines bit piece digital output circuitry bit piece digital input circuitry bit piece pinmode bit piece digitalwrite bit piece delay bit piece digitalread bit piece analog input circuitry bit piece analogread bit piece analogwrite bit piece bit piece interrupt appendix index included language coverage seldom used small medium scale embedded work including modest comic relief film noir buff embedded controller course introduction overview course introduces c programming language specifically address issue embedded programming assumed worked high level language python basic fortran pascal complexity embedded system begin typical desktop examine structure language basic example decent grounding syntax structure development cycle switch embedded arduino based development course designed considerable work home minimal cost choose entirely optional programming little beasties addicting forewarned course text associated lab manual need arduino uno board usb host cable small wall wart power adapter useful s lot free c programming info internet prefer print book want wish purchase c programming text available good title kochan s book programming c deitel deitel program whichever book choose make sure focus c need desktop c compiler just including visual borland codewarrior gcc couple decent freeware compiler available internet include pelles c miracle frequently asked question learn c language programming c widely used development language today good reason consider s modern structured language standardized ansi modular allowing reuse code widely supported allowing source code used different platform just recompiling new target popularity mean library module available stretch language type checking help catch error powerful allowing close metal creates efficient code small space fast execution s difference c superset came c came fact programmer s joke increment operator literally mean increment c c doe c doe plus lot extra feature don t come free embedded application usually afford overhead consequently embedded controller work c embedded work desktop development system usually referred system meaning ll embedded development system strictly c variant buy arduino development board arduino uno board available variety source including mouser part express shop s difference desktop pc development embedded programming desktop development focus application desktop computer include thing like word processor graphing utility game cad program thing people think hear word computer embedded programming focus myriad nearly invisible application surround day example include code run microwave oven automobile engine management cell phone term total unit embedded application far outnumber desktop application pc house probably use dozen embedded application day embedded microcontrollers tend powerful expensive pc counterpart differing programming technique integral course shall spend considerable time examining doe c compare python like student taking course background python language certain aspect c little odd overly complicated alarmed core language actually simple python tends hide thing programmer c doesn t initially make thing complicated doe simple program complicated task c tends cut heart matter kind data hardware manipulation direct efficient c language practical consideration c compiled language version python essentially interpreted mean extra step development cycle resulting compiled program efficient examine little later doe c compare assembly language assembly traditionally used code space speed utmost importance year ago virtually embedded work assembly microcontrollers increased power c compiler improved table turned downside assembly weighs assembly unstructured standardized particularly easy read write c offer similar performance characteristic assembly advantage modern structured language embedded controller c memory organization introduction programming c help know little internal working simple computer system c tends close metal way certain thing performed preferred coding technique apparent let s narrow field bit declaring investigate fairly simple sort thing embedded application mean basic processor solid state memory won t worry disk drive monitor forth specific detail concerning controller architecture memory hardware internal io circuitry covered later chapter gut basic consists control device called cpu central processing unit microprocessor microcontroller subtle distinction little need deep point microcontrollers tend powerful standard microprocessor term processing speed usually array port hardware function digital converter chip typical microprocessor thing simple shall use term processor generic microprocessor normally connected external memory ram chip microcontrollers generally contain sufficient memory alleviate requirement worthwhile note talking large megabyte quantity microcontroller contain byte memory simple application sufficient remember byte memory consists bit bit thought pair order processor operate data held memory data copied processor s register dozen register register mathematical logical operation carried example desire add variable value variable copied register addition performed register content yielding answer answer copied original memory location variable little roundabout don t worry c language compiler care detail memory map byte memory computer address associated requirement address processor way identifying specific location memory generally memory addressing start work way address special reserved system specific address refer normal memory instead refer certain port external communication useful draw memory map huge array memory slot people draw lowest starting address people draw lowest address embedded controller s example just byte memory address address address address address address figure simple memory map address slot represents place store byte remember specific address doing lot work instead c compiler track example declare char named x address need print value don t say fetch value address instead say fetch value x compiler generates code make work proper address abstraction eas mental burden considerably variable require byte need combine address store single value example chose short int need byte suppose variable start address require use address access variable compiler automatically generates code utilize address know using short int little byte memory map hold char short int long int short int long int char similar combination hold double requires byte similarly hold array short int chapter detail numeric data type array special contiguous memory example suppose byte memory element char array declared array start address slot allocated array created scattered fashion byte byte requirement manner array indexed accessed shall later stack program need temporary storage certain variable variable used limited time thrown away inefficient allocate permanent space sort variable place system use stack ordinarily application split part code section data section data section contains permanent global data consume entire memory map remainder memory used temporary storage stack stack start opposite end memory map grows code data section called stack filo stack work like stack tray cafeteria tray placed stack pulled vice versa temporary embedded controller needed memory area used item needed memory taken code exit function temporary auto variable declared longer needed stack shrink make function call declared variable possible stack overrun code data section program corrupt proper execution functioning program unlikely address area used code data area currently unused stack area grows address address figure basic memory layout memory map example byte memory individual memory slot shown general area shown worthwhile note system code data common area shown v neumann architecture physically split harvard architecture split basic concept remain want split area accessed memory simple separating code data allows processor fetch instruction code using memory bus physically separate data bus currently accessing shared memory bus require special timing coordinate process thing bus given time having separate memory bus speed execution time bus typically refers collection wire connection multiple data bit address bit sent group embedded controller controller c language basic introduction c terse language designed professional programmer need lot little code quickly unlike basic python c compiled language mean written program need fed compiler turn c language instruction machine code microprocessor microcontroller execute extra step result efficient program interpreter interpreter turn code machine language s running essentially line time result slower execution order run program machine machine interpreter think compiler doing translation instead line time unlike language c line oriented instead program thought consisting major component variable statement function variable just place hold thing language integer floating point real number type statement include thing variable operation assignment set x time y test x forth function contain statement function variable naming type declaration variable naming fairly simple variable name combination letter numeral underscore upper lower case mixed length typically character max actual limit depends c compiler use variable reserved key word contain special character legal name include thing like x volt c support handful variable type include floating point real number basic flavor float bit number double higher precision version using bit integer type including char bit short int bit long int bit char bit hold combination different value sufficient single ascii character similarly short int short short hold combination value char ints signed unsigned signed allowing negative value default plain old int bit depending efficient compiler safe use plain old int value require bit come special double long integer called long longs byte bit extended precision float defined ieee embedded controller table summarize size range variable variable type byte used minimum maximum char unsigned char short int unsigned short int long int billion unsigned long int billion float significant digit e e double significant digit e e figure numeric type range c support array compound data type shall examine later segment variable declared used created whim speak python declaration consists variable type followed variable optionally initial value multiple declaration allowed example char x declares signed bit integer called x unsigned char y declares unsigned bit integer called y short z declares signed bit integer named z float b declares real number named b set initial value note declaration followed c language way saying statement end mean little sloppy unique way dealing space following equivalent legal float b float float b embedded controller function function use naming rule variable function use template look like function argument list statement s figure basic function template think function mathematical sense value s give value example calculator sine function send angle give value c function argument just argument c function return value don t gut function defined opening closing brace pair function take integer x y argument return floating point value look like float int x int y appropriate statement function doesn t return value word void used function requires value return value look like void void appropriate statement appear extra fussy work listing data type make lot sense c called type checking mean try send function wrong kind variable wrong number variable compiler warn ve mistake try send float integer compiler complain save big headache testing program place start c program execution begin function called main doe function written listed program function called main s program figure following embedded controller program void main void float x float y float z z x figure simple program function main take variable return s stuff pair denotes inside comment pair ignored compiler c comment stretch line inside function variable declared given initial value variable x y multiplied divided sum assigned c equivalent ugly version program void main void float float float z figure alternate format avoided complete opposite python rigid spacing formatting rule suppose add multiply divide operation need lot split separate function program look like figure following page c allows denote single line comment backend pairing embedded controller second program float float float b float answer answer return answer void main void float x float y float z z x y figure program separate function new math function take float argument return float caller compiler see new function used main know sent float return value assigned float important note new math function us different variable name b caller x y variable new math function really just value original x y copied new variable b used new function copy altered changing original value x case x y said local main function b local function word isn t visible main t accidentally alter similarly x isn t visible t accidentally alter positive boon dealing large program using variable name s usually preferred time want variable known called global item make variable global simply declaring beginning program outside function right initial comment example library example limited perform calculation way seeing result need way print answer computer screen rely function library series library included c development system cover variety need essentially coded tested compiled bunch function add function program process called linking linking simply combine compiled code required library code final executable program basic printout data input like use standard io library stdio short function library named printf print formatted embedded controller type checking know new function tell compiler look special file called header file information library associated header file usually normally end file compiler directive called include statement program example single line comment include void main void printf hello figure program library function program simply print message hello world screen combo special formatting token mean add new line bring cursor line did add include directive compiler wouldn t know printf complain tried use s header file thing contain function prototype prototype template create cutting pasting function argument list adding semicolon function prototype earlier math function float float float b make library function want use d need appropriate include statement code remember add library code linker allow reuse code save time look multiple file project library later segment consequently want print answer program d wind like figure following page worth noting large number subgroup code collected referred c standard library precise implementation dependent operating header file remain distinct embedded controller fourth program include void main void float x float y float z z x printf answer z figure complete program f printf function serf place holder variable need print value like printf answer f f x y z case f used x second f y final result look like answer simple math c us basic math operator language include divide multiply parenthesis used group element force hierarchy operation c includes modulo modulo integer operation leaf remainder division modulo divide behaves little differently integer float remainder integer divide using float c series bit manipulator look little later higher math operation want look math library header file example sin co tan common log pow power root try use calculator x raised y power pow x y operator entirely different meaning c recalling said earlier library wanted use function like sin code d tell compiler prototype similar info program d add line include embedded controller final caution example meant clear necessarily efficient way doing thing shall way code huge impact performance given power c expert programmer create code nearly indecipherable ordinary people method apparent madness program cycle create c program requisite mental work important c source code using text editor normally ide integrated development environment c source file plain text saved extension source code creates assembly output file normally compiling automatically fire assembler turn assembly file machine language output file output file required library using linker creates executable file desktop development ready test embedded development download resulting executable target hardware case arduino development board arduino step combined selecting build ide menu executable doesn t behave properly step summary thing mind learning c terse lot little code allows novice trouble quickly relatively language meaning function language se come library call function call function call code free flow line oriented line code usually terminated semicolon allow expert create code indecipherable normal programmer variable declared use free flow python global local scope local variable known place program embedded controller exercise write c code comment includes date use single line line style write function floating point value argument function return average value argument write program print embedded controller controller c basic ii input output ve seen use printf send information computer screen printf large complicated function possible variant format specifier format specifier thing used placeholder value example ffloat lfdouble long float efloat using exponent notation gfloat using shorter e f style ddecimal integer lddecimal long integer xhexadecimal hex base integer ooctal base integer uunsigned integer csingle character scharacter string figure print format type suppose wanted print value variable an decimal hex octal following instruction printf answer d hex x octal an an an note variable labeled important printed hex form label know hex decimal example just saw number know s decimal hex decimal matter set hex constant c code compiler way knowing hex value prefixed hex printf function doe automatically add output reason prove distracting table filled hex value s easy use d instead just d output format add field width specifier example mean print integer decimal space minimum similarly mean print floating point value using space minimum portion precision specifier case indicates digit decimal point used powerful flexible function mirror input function scanf similar python s input statement ask value generally best ask single value using function us sort format specifier printf important point note scanf function need know place entered value computer memory simply informing variable insufficient tell memory variable word embedded controller specify address variable c us operator signify address example wish obtain integer user place variable called voltage program fragment like printf enter voltage scanf d voltage common new programmer forget forewarned variable size common question new programers size variable available different size real float bit double bit different size intgers bit language s just real integer size variation doe c offer choice reason size doesn t fit option order optimize code variable range say s need use short bit integer using bit integer simply us memory consider extra byte big deal remember talking embedded controller case desktop system small controller byte memory available data desktop system gigabyte memory choosing wrong size disastrous example suppose analog digital converter audio cd standard sampling rate sample second sample bit value byte producing data rate byte second imagine need memory minute song stereo work nearly megabyte memory chosen long bit integer hold data d need megabyte instead value placed audio cd exceed bit foolish allocate bit value data size multiple byte t choose integer say bit length s controller upper limit bit case float versus double float used space premium smaller range size exponent lower precision number significant digit double double generally preferred norm math function plain float referred single single precision versus double precision don t know size particular data item example int bit depending hardware compiler use sizeof command look like function s really built language argument item expression interested return size required byte size sizeof int size depending system bit double bit integer available embedded controller math ok happens add multiply short int result bit long wind overrange condition note compiler warn happens depend entirely value entered user subsequently computed program hopefully consider maximum value case choose appropriate data size won t problem actually happens simply bit ignored consider bit unsigned integer go represented happens add value bit number followed ninth bit thrown away variable bit plus equal create problem example suppose wanted use variable loop counter want loop time loop terminate bit integer t high adding keep flipping hit behavior bad fact good use thing like interrupt timer shall happens mix different type variable example happens divide double int float double c promote lesser type larger type operation present problem try assign result smaller know fit compiler complain divide long int long int try assign result short int using cast way telling compiler know potential problem ahead hopefully know work just want defeat compiler warning casting c similar type conversion python int function s example short int x long int short int note directing compiler turn division short int result fact long int promotion y level s value x s course remember fractional meaningless lost integer divide casting useful using math function use float cast double make use function defined double example suppose b c declared float wish use pow function raise b power pow defined taking double argument returning double answer c float pow double double b explicit example time rely silent cast promotion work integer example explicit good practice just form documentation embedded controller bitwise operation d like perform bitwise operation ordinary math example want logically variable bit bit bitwise operation common programming microcontrollers mean setting clearing testing specific bit control register example setting specific pin digital port read mode instead write mode c series bitwise operator s complement shift right shift left figure bitwise operator note double use address unary operation address binary operation b imply address wanted x y shift result place left assign result z d use z x y let s look example suppose variable x y z unsigned char x y set respectively hex s bit pattern z x z z x z z z z z z x y z z z setting clearing reading register bit bitwise operation appear somewhat arcane uninitiated fact commonly used prime use setting clearing testing specific bit register example involves configuring bidirectional port input output mode data direction register typically abbreviated ddr bit ddr represents specific output pin logic high indicate output mode logic low indicate input mode assuming ddr bit register wanted set bit bit input mode ddr set bit zero output mode c bit position counting like sequence start position position embedded controller later wanted set bit output mode keeping intact easy way simply bit want ddr ddr prior operation performed using common shorthand ddr note preceding code doe affect bit stay mode originally way set specific bit referred bit pattern bitmask specific bit set simply instead bit ddr set output mode use like ddr true set clearing bit requires anding bitmask complemented word reversed bit pattern example want clear bit d complement bit pattern yielding ddr s easier just use logical complement operator original bit pattern ddr dealing single bit use left shift operator don t bother figuring bit pattern hex set bit clear bit ddr use following ddr ddr operation common invoked using expansion define define desirable use symbolic constant place actual value example d probably prefer use symbol pi instead number define preprocessor directive normally header file module c source code like define pi compiler see time come token pi replace value directive us simple substitution complicated thing example create look like function embedded controller define parallel x y x y x y x y serve placeholder line parallel b c get expanded b s expansion macro mean s function overhead operation run faster time read like function s easier programmer follow ok extra parenthesis reason x y placeholder item expression simple variable did way trouble define parallel x y x x expression following example parallel c expand multiplication executed addition wind added product b time c division sum b multiplied c quantity divided using extra parenthesis order execution maintained referring bit field operation useful definition appear function fact bitwise operation expanded define bitread value bit value bit define bitset value bit value bit define bitclear value bit value bit simply mean expressed unsigned long finally bit defined symbol lead nice looking code define ledbit code bitset ddr ledbit define expansion quite tricky nested reference mean define contain symbol define following little tedious time ultimately worth effort shall look road remember make programming easier obfuscate code start simple math constant substitution extremely useful easy use just mind microcontrollers specific register port given symbolic name embedded controller remember precise numeric address norm place symbolic constant cap keywords list keywords c language figure c language keywords ve looked quite haven t probably guess use stated previously c skinny language exercise write line code print statement result x volt x value given floating point variable write line code define constant called equal write code determine number byte required variable called assume bit variable x exists write code set msb significant bit leaving bit unchanged assume bit variable y exists write code set lsb significant bit leaving bit unchanged assume bit variable z exists write code clear msb lsb leaving bit unchanged assume bit variable w exists write code complement bit flip x y b x y c d y x y b x y c d y embedded controllersautobreakcasecharconst continue dodefaultdoubleelse entry externfloatforgoto intlongregisterreturn sizeofshortstaticstructswitch typedef unionunsignedvolatilewhile controller c storage type scope type c way storing referencing variable affect way variable behave common one auto register static auto variable variable declared function static register type auto keyword default normally auto variable created application s stack c doesn t require stack basically chunk memory allocated application s use run place temporary storage value popped pulled stack order like stack plate unless initialize auto variable idea value use value happens memory location previous time used important understand includes subsequent call function prior value remembered time function subsequent function doe produce memory location variable anymore wind plate time cafeteria register variable similar auto type behavior instead using usual stack method cpu register used available exact implementation cpu compiler specific case register keyword ignored simple auto type used cpu register offer faster access normal memory register variable used create faster execution critical code typically includes counter pointer incremented inside loop declaration like like register int x static variable used need variable maintains value function call need variable appear way left use like static char y important difference auto static type concerning initialization auto variable initialized function char set time function entered initialization static static char b set subsequent entry function incur initialization did reinitialize sense having static type explained fact static doe usually use stack method storage placed fixed memory location c doe require use stack typical implementation embedded controller useful common modifier volatile const volatile variable accessed modified process task special us typically prevent optimizing compiler aggressive later const modifier used declaring constant variable change value instance preferred using define type checking available t use interchangeably scope scope variable seen mentioned idea global local previous work time delve little deeper generally variable exist block declared legal declare variable inside conditional loop block normally declare variable beginning function consequently variable known function scope reference function outside function know say local localized function example consider function fragment void void int x int y code void void int y int z code direct way access z variable likewise direct way access x variable interestingly y variable entirely different refer variable confusing new programmer essential large program imagine working team people large program ten thousand line long idea local scope did exist d make sure single variable program unique create nightmare confusion using local scope saying need variable job function need exist function meaningful form universally known data item needed resort global globals act pretty like static usually stored way program consists single file declare globals listing beginning program outside function way read compiler known function follow habit declaring variable global considered bad inefficient coding method habit using local norm resort globals called embedded controller multiple file project function second file recognize globals declared file case ll create header file use include directive example suppose project consists c source file named declare following global int m order function m ll create header file called contain following extern int m meaning integer named m declared externally file ll add line include compiled compiler open variable m declared put known variable list continues compile remainder code come m function compiler understands variable declared file problem header file largely composed definition declaration place external data function prototype exercise assume function declares variable like static int function increment variable print value doe function print tenth function change static keyword used consider following snippet code void doug void int printf x void dinsdale void int printf x suppose doug time row dinsdale time row resulting output look like embedded controller controller c array string introduction haven t talked character string variable contain data person s address string variable type c unlike python c string array character array simple grouping like variable sequence accessed index number behave similarly array language list python c array dimension example declaration float result array float long int x array longs byte char y array char byte total note use square bracket use multiple set square bracket higher dimension array c array counted index example item result result item result item result constitute illegal access array listing value brace separated comma double leave index element initialize short int b element declare initialize remainder set zero array global static auto short int c remaining set dealing character string enter ascii code character tedious case c let s specify character single quote translation char m m y d o g reason trailing evident moment easier specify string double quote char n cat consider string n contains character declared hold need copy string variable future time declaring larger value variable hold larger string later point wondering c library function know use just portion allocated space given time case just reason apparent cover address pointer embedded controller possible simple rule string null terminated character final character use null numerically case direct string initialization n null automatically added final character case initialization m manually null extremely important function manipulate print string look trailing null order determine work null termination function just churn memory eventually hit null cause violation application operating crash note char fido actually declares character letter plus terminating null c count index declaration equivalent f d o trailing null written important note backslash entirely different meaning mean null mean numeral string manipulation confusing aspect c string beginner especially coming basic python manipulate copy string compare string extract substring forth string really array t assign b instead rely series string function string library use function need link code string library use include start code copy string use strcpy template strcpy destination source wanted copy content n write strcpy n awake point ask s ampersand good question string copy function need starting address array essence doe copy character time source destination hit trailing null s ve seen address operator earlier looked scanf saying source start address character destination start character n little cumbersome c offer shortcut think sort canceling d normally write strcpy n note perfectly acceptable use index zero need copy just chunk string start copying index d like just instead fido embedded controller n shortcut using strcpy n don t start address element start character later ll look sort manipulation closer examine address pointer happens source string character destination string allocated example did strcpy n result memory overwrite accidentally destroy variable function bad program crash case operating crash protect use strncpy place limit number character copied adding argument destination space character d use strncpy n function stop character unfortunately won t automatically null terminate string limit reached safe d need add following line force null termination remember c count index fifth final element function available manipulate string individual character short list strcmp compare string alphabetically strcmpi case insensitive strncmp compare string max length strncat concatenate string max length strlen length string count char null figure string function following work single character just sampling idea s use include isupper determines character upper case isalpha determines character alphabetic numeral punctuation tolower turn character lower case version figure character function embedded controller don t library documentation instructive simply open various header file look function prototype s available don t edit file finally need convert numeric string integer floating point value use function atoi atol atof ascii int long int ascii float exercise write code declare array single precision real number write code declare array bit signed integer assume array double precision real number declared named point write code print item point write code set item point declare string called mammal initialize word woodchuck potential problem snippet initialization code explain issue corrected char bird bird s bird w bird bird l bird l bird o bird w embedded controller c conditionals looping conditionals c us fairly standard construct basic conditionals nested portion consist statement condition multiple element formed positive negative logic basic construct test condition s stuff portion optional look like test condition s stuff stuff single statement block brace brace removed desired test condition s single statement statement test condition check numerous possibility operator greater equal equal figure relational operator important note equality us double equal sign single equal sign assignment operation don t think equal think symbol word use boolean logic operator shown figure embedded controller figure logical operator note logical operator behave similarly named bitwise operator example logical return true argument necessarily bit yield yield true true taken value variable expression evaluates value zero logically true result zero logically false time example conditional written fragment explanation following taken variable b taken long variable b isn t b taken long b b taken long b taken zero way saying taken zero taken zero way saying taken zero word following code fragment equivalent common new programmer use want disastrous result consider following code fragment embedded controller doe glance think test b doe kind instead assigns value b check value word doe trick help constant reverse normal order instead writing use way accidentally use single equal sign compiler cough syntax error nesting multiple condition won t cut nest test nesting conditionals easy test condition s test test level deep desire note c unlike python doesn t require indenting shown expected formatting selection single value list use construct template look like switch case stuff break case stuff break default stuff value list break embedded controller default section optional doe final item list break left code simply fall case code execution jump closing brace case stacked action statement case include legal statement including assignment function call note check range case expression case discrete value following example show action statement replaced simple comment switch x case code performed x jump closing brace break case code performed x jump closing brace break case code performed x continue case break statement case case code performed x break default code performed x jump closing brace redundant break handy replace numeric constant define value example choosing menu different circuit create define value start file header file define define define write legible like switch case volt div stuff break case emit fdbk stuff break embedded controller looping looping construct really just loop continuation test end instead beginning iteration continuation test follows rule construct template test condition s statement iterate statement iterate test condition s example incremented start loop executes incremented start loop executes b loop continues b zero condition halt loop variable b loop continue usually loop use form counter obvious way implement counter statement like add current value c increment decrement operator say thing like add current value subtract current value c shortcut mode operation example equivalent equivalent embedded controller form increment example production code increment decrement operator generally preferred construct generally preferred specific number iteration known template initialization s termination test s increment s statement iterate example using variable counter start proceeds adding time loop iterates time stuff time following example similar add loop iterating time stuff time example us multiple note use comma b stuff time case variable initialized loop completion incremented b multiplied note b used termination section iterated block brace consists single statement brace left just like construct loop nested contain legal c statement including assignment conditionals function call like terminated early use break statement construct break command redirects program flow closing brace example b b b break embedded controller visually reinforced use indent spacing s make code behave entered like b b b break obviously style easier read later strongly recommended follow style write code ok doe code fragment set b check b time doesn t iterate check b s break isn t executed concludes iteration second iteration incremented checked s loop continues enters b smaller time b doubled smaller s doubled finally doubled larger time loop exit isn t true larger break isn t taken wind finishing iteration incrementing loop start b time loop execute leaving b break ignored close incrementing iteration ignored b time happens incremented start b doubled s greater time exit b greater taken result executing break statement directs program flow closing brace loop execution pick line following closing brace loop get example admittedly little tricky follow necessarily best coding practice doe illustrate various part operate use make simple loop loop handy initialization termination increment spot loop specify termination remember write variable initialization loop increment loop forget loop behave erratically fail terminate altogether resulting infinite loop shown printf code fragment doesn t print word hello time print hello forever better say forcibly terminate program initialized tested incremented need similar loop embedded controller exercise write code examine value variable s zero message negative value printed write code examine value variable s equal zero message zero value printed write code compare value variable x greater value printed write code examine value variable x x y greater zero increment x write code necessary print message error time using sequential printf call write code required control loop continues long variable k write code needed cycle variable r step explain practical difference loop loop embedded controller c pointer address introduction recall earlier course work byte memory computer identified unique address c work directly address reason used create efficient powerful code obtain address virtually variable data item using address operator exception register class variable cpu s register don t address like normal memory function just memory location filled c make possible obtain starting address function using address pointer declare variable char referencing value stored code using address operator obtain memory location s value content sort thing used scanf strcpy possible declare variable designed hold address called pointer declare pointer preface variable asterisk like char pc variable pc char pointer char content address char variable content pointer address important point consider following code fragment based declaration pc unhappy pc just fine line make sense trying assign apple orange speak second line make perfect sense pc sort thing address variable hold char want pointer kind thing problem just follow example float pf pointer float long int pl pointer long int double pd pointer double short int p p pointer short int just short int mentioned pointer contain address matter pointer point pointer size number byte modern system pointer bit byte bit byte small controller use bit addressing doubt check code sizeof pointer size declare different embedded controller pointer reason help type checking function pointer argument return pointer using certain form data wouldn t want accidentally send pointer float function expects address short int example second specifying type thing pointer point rely compiler generate proper pointer math moment pointer dereferencing suppose following code fragment char pc c b c pc c declared variable char pointer char set content char set content pointer address char don t really need know address sake argument let s say c located memory address pc located memory address search computer s memory address number address number address char variable typical value span bit byte word memory used pc address conversely bit pc span half byte far fewer possible address content value pc tell char resides location value char variable dereference pointer asterisk say b pc read b get value address given pc pc doesn t value tell value s went professor s office asked grade instead hand piece paper read paper doesn t indicate grade show sound unduly complicated turn myriad us way example value b pc point c assigned value start b get value address pc point simply pointer math really neat thing pointer pointer math returning example pc address increment pc ll surprise right hand pointer double pd address incremented wouldn t wind fact d wind come large thing pointing double byte bunch array incrementing pointer item array extremely useful note adding subtracting pointer make perfect sense multiplying dividing higher manipulation generally make sense avoided embedded controller pointer array use pointer array example use string noted earlier work recall address array index cancel following equivalent somestring somestring let s look example use pointer instead normal array indexing shall write version strcpy copy string function take argument address source string address destination string copy character time come null termination normal array index way void char dest char source int index variable init char source s null dest source copy char increment index dest null terminate look pretty straightforward right minor improvement make changing loop source s big deal contrast let s write thing using pointer void char dest char source s s work dest source starting address string say dest source happens value source point get copied address referred dest copy character add post increment operator line copy character increment pointer pointer contains address character array ve got love pointer math work sized datum placing code loop content character copied loop continue loop won t stop terminating null copied imagine underlying machine code simpler compact faster execute said outset course lot c just little code embedded controller exercise declare pointer floating point variable naming fptr declare pointer signed character variable naming cptr consider following snippet code unsigned char c p explain difference c consider following snippet code unsigned char p double assume value p currently value value following piece code executed explain difference operator relation pointer consider line code b c operator pointer dereference multiply know consider line code b c think line doe alter line mark intent clearly prone error misinterpretation explain difference line code b embedded controller c table introduction use tool make thing thinking tool world software thing implementation huge impact performance turn trade performance area example certain technique memory efficient slow execute vice versa going look common programming technique fast computationally efficient require lot memory s called table yes d like table consider common c trig function sin really pas argument sine argument implemented implemented taylor series expansion requires multiplies add single sine computation won t long need million multiplies add add speak consider following problem need sine angle specified nearest degree fast basically possible answer degree degree suppose create array value consists sine angle degree increment starting degree working degree look like double entry compute sine like given argument angle answer angle duality array pointer write answer angle optimizing compiler second form probably generate efficient machine code case fast s reading memory location offset result just add plus access instead dozen doe come cost double float byte nearly memory recognizing sine function quarter wave symmetry add little code check quadrant reduce table just entry float sufficient precision application cut memory requirement half compared double outside bound perform minor integer math bound angle just mod remainder degree effectively wrap embedded controller make just little spiffier make look like function define follows define course operation deal integer argument accurate single degree alter definition allow floating point argument round nearest degree follows define int turn true function add code interpolate adjacent degree entry accurate result point extra refinement slow function point direct computation competitive waving quickly s business needing sort thing fast application direct digital synthesis arbitrary waveform idea create waveform arbitrary shape just usual sine square triangle possible arbitrary waveform realized using analog oscillator technique coupled wave shaping circuit challenge instead consider creating large table integer value typically table size nice power like entry table digitized value desired waveform simple ramp look like unsigned short int complicated wave look like unsigned short int value sent sequentially converter dac create desired waveform end table simply loop start make cycle entry table use unsigned char table index reach incrementing cause roll automatically post increment operator ideal code assume port memory location dac writing unsigned char loop forever port wait value dependent sample rate delay embedded controller error correction table translation possible use table error correction let s limit nice entry table suppose reading sensor bit level converter adc maybe temperature sensor extreme temperature range tends calibration use input value sensor appropriately scaled turned integer index element table contains corrected value example simple let s say sensor read temperature ranging c calibrate placing known oven sensor read instead ideal repeat process temperature discover read s really s really create table entry entry entry use sensor value index array value access corrected result table effectively translates input calibrated output fast process accurate calibration measurement long sensor data repeatable read c oven ll good result embedded controller controller c structure introduction c allows compound data called structure struct short idea use variety basic data type float int sort object structure contain type pointer array structure us construct structure common production c code example wish electronic component transistor sort thing need performance parameter used current gain breakdown voltage maximum power dissipation item represented double variable model number probably string contain letter need manufacturer s code int real world device parameter suffice purpose transistor deal separate variable big deal track hand great number part database device creating separate variable keeping straight present bit challenge nice combine item super variable worry creating database array technique shouldn t problem getting current gain device confused structure come example define transistor structure associated instance struct transistor double currentgain double breakdown double maxpower short int manufacturer charmodel struct transistor struct transistor ptransistor defined structure type transistor declared instance struct transistor called pointer struct transistor called ptransistor element referred field structure currentgain field note structure contains array character model model exceed character plus terminating null yield declared unlikely ll model long chance truncate set retrieve value instance use period separate structure field example embedded controller assignment better use define hard number example place following definition header file use assignment define motorola motorola set model field like strcpy remember strcpy need address double quote string literal produce automatically model field using shortcut described earlier work line equivalent strcpy need use field computation comparison access unchanged printf breakdown voltage volt good question point declared order field make difference depends compiler target hardware processor variable long short integer float pointer word aligned example short int required start address float required start address divisible structure declared order char float char int need pad byte field ensure alignment memory space structure organized float int char char particular importance large array structure used pointer structure generally good practice send entire structure function argument reason wind copying lot data transistor structure contains double byte short int byte byte char array leaving total byte memory need copied pas function efficient simply passed starting address structure function tell function structure using pointer called passing reference versus familiar passing value declared ptransistor initialize like ptransistor access various field longer use period longer struct transistor pointer pointer access field pointer token dash followed greater sign say currentgain strcpy model embedded controller function simply print value various field void struct transistor pt printf model model printf current gain currentgain printf breakdown voltage breakdown printf maximum power maxpower note use s string lf long float double pas function pointer transistor structure like use ptransistor initialized structure array seen possible array structure possible structure structure pointer structure example structure definition struct foo float x float y struct bar double pd struct foo littlefoo struct foo pf variable declaration struct foo struct bar struct bar pbar double bar structure contains pointer double pointer struct foo struct foo access follows z pd isn t double address pf x note didn t say pf x evil assigning pf pointer contain random number second embedded controller use number starting address struct foo write number x field s highly unlikely random number starting address struct foo number overwrites mean data code get destroyed program behaves erratically crash pointer rule number uninitialized pointer bad evil thing happen sad programmer beginning transistor example noted want create bunch transistor possibility use array way shall s d declare array transistor structure given definition struct transistor transistor access field follows transistor set device s gain transistor set device s breakdown finally possible create array pointer transistor structure struct transistor ptarray note transistor structure pointer need point appropriate transistor structure assuming declared named did earlier write ptarray access field like ptarray maxpower look little odd sort construct doe good us advanced application stretch mind just teensy bit c make possible create like array pointer structure contain structure turn contains array pointer structure read imagine look like memory map write possible ve pretty mastered idea exercise declare structure type quest called grail contains float called x long integer called y unsigned character called z given structure problem order field effect importance determine doe try access field embedded controller c linked list introduction linked list alternate way collect number instance given data type compared array linked list offer advantage requiring contiguous memory collection easy way collection simply swapping pointer shall later linked list flexible come adding deleting item collection downside linked list require somewhat memory array space pointer included array offer consistent fast access member array linked list require list walked order given member create linked list pointer structure type included definition structure instance structure type created strung placing appropriate address pointer field graphical example shown instance structure figure linked list imagine structure byte size assume located memory address spanning b located address c d structure contains pointer list contains pointer address b b c forth example value s pointer memory address b value c s pointer address d note list item signifies item remain having pointer set item linked manner simply changing pointer value finally item b c d reside memory map need contiguous contrast make array structure need packed memory sequence order indexed properly located address b c d byte wanted rearrange structure sort add new one delete existing one require quite bit work array indexing work simply multiplying index value size arrayed item using value offset starting address example item c multiplying index size byte achieve offset starting location address remember item item b item embedded b c d d array task easier linked list structure aren t manipulated associated pointer linked list example concrete example typical structure definition look like struct marmot struct marmot nextmarmot float age float weight declare instance marmot link follows struct marmot larry struct marmot jane larry struct marmot felix jane felix list larry note item declared inverse order pointer reference exist prior assignment jane exist order felix use jane address common declare pointer use head list add struct marmot marmotlist felix following true point jane nextmarmot point jane point larry nextmarmot point larry nextmarmot final line pointer pointer practical use temporary pointer example function take head marmot list argument print age marmot list void printmarmotages struct marmot struct marmot temp temp initialize pointer list temp true marmot exists printf age temp nextmarmot embedded controller called like printmarmotages marmotlist note reused use local temp case head list needed function local variable required temp nextmarmot effectively erases prior value temp lose head list walk list exercise bipolar transistor described partially following information number typical beta maximum rating p d ic bvceo using data create program allow user search device meet minimum specified requirement beta pd ic bvceo device meet performance spec printed table data field shown device meet spec appropriate message printed instead example user search device p d watt device p d printed devicebetapd w ic bvceo v embedded controller controller c memory introduction needed variable simply declared globally locally time approach practical consider program deal large data external file word processor graphic sound editor instance application need open large file megabyte size issue merely size declare large array problem data large variable size example edit sound file s byte size need edit s time larger wise declare megabyte array need guarantee declare megabyte day come ll need megabyte needed way dynamically allocating memory size needed needed free memory pool given computer memory used operating running application memory left considered free memory pool pool necessarily contiguous broken different sized chunk depends application run operating deal total free memory location various chunk change time c offer way asking operating block memory free pool operating grant request access memory use fit using memory tell operating reuse sound simple right allocating memory use memory routine include header code sure link standard library main memory allocation function malloc calloc prototype void malloc unsigned int size void calloc unsigned int unsigned int malloc take single argument number byte wish allocate free pool calloc take argument number item want fit memory block size byte basically calloc just call malloc multiplying argument used convenience function return pointer type void void pointer thought generic pointer prevents possible type size clash assign void pointer type pointer type mismatch memory request memory function return null check null return assume allocation work embedded controller want obtain space byte d like char cp cp malloc cp memory allocated stuff allocated warn user fail gracefully need space double d like double dp dp calloc sizeof double assign test memory allocated stuff allocated warn user fail gracefully note use sizeof operator structure needed create example add linked list struct foo fp fp calloc sizeof struct foo remainder using memory pointer returned allocation function used base object array object interested keeping simple suppose want allocate array integer want set element second element following code fragment error processing shown int ip ip calloc sizeof int ip say ip say ip embedded controller freedom pointer used normal pointer thought base array indexed accordingly similarly need allocate structure initialize field function allocate struct foobar initialize field return pointer struct foobar double d int char code struct foobar void struct foobar fp fp malloc sizeof struct foobar d just stuff strcpy timmy return fp freeing memory using memory return free memory pool don t application operating use memory effectively lost rebooted known memory leak return memory use use free prototype int free void p p pointer initially received malloc calloc return value free function success error normally function fails given valid pointer doe fail little level remember block allocate eventually freed wonder free function doe need know size block free memory pas malloc calloc actually allocate little bit use operating extra memory don t stored item size block save little house keeping work operating specific routine standard routine examined augmented special routine unique given operating control using virtual memory presetting memory value allow obtain access special kind memory graphic memory embedded controller exercise write code allocate byte memory write code allocate space array single precision floating point value write code free memory allocated problem embedded controller c file io introduction high level fileio c us function fopen fclose fread fwrite fprintf fgetc utilize variable type file access disk file allow read write data file disk manner similar sending data computer screen printf retrieving data keyboard scanf closer home low level fileio use file descriptor basically just integer high level function actually low level function thing need file open obtain access existing file create new read write data file need file reread data skip data finally finished using file close open file use fh open mode char disk file int fh file descriptor int mode define fh file descriptor needed subsequent call o ok error example mode read write create exists data use count read fh buffer len count write fh buffer len fh file descriptor returned open buffer address data thing copying disk making copy disk len number byte count actual number byte common construct count read fh buf len len error process embedded controller skip file apos lseek fh rpos mode long apos absolute position error long rpos relative position mode relative beginning file rpos relative current position relative end rpos note present position lseek fh o file close error close fh error o went ok c allows multiple file open simultaneously reading writing need file descriptor file open time reused later desired program used investigate content kind file us variety technique examined course line wrapped program spit byte file hex decimal string form non printable char printed period include include include include define chunksize unsigned char buf chunksize char szerrmsgs error usage s filename open seek error position error rewind error read error void file fp int err char pc fp fclose fp err printf szerrmsgs err pc bother ok exit err embedded controller main int argc char argv int size x file argc strcmp argv fp argv fp fopen argv r big file chunksize read available fseek fp seek end size ftell fp size chunksize size chunksize fseek fp seek start fread buf size fp unsigned int size print char line hex decimal string c size print line hex printf c buf c buf buf buf buf buf buf buf print line decimal printf buf c buf buf buf buf buf buf buf print line string check char printable replace period x isprint buf buf printf c c c c c c c buf c buf buf buf buf buf buf buf fp argv fp argv fp argv fp argv fp argv fp argv embedded controller controller c command line args command line argument question various utility read argument place command line example utility archive compress file creating new compressed file use like do shell prompt c archive program called archive telling compress file create new file called faster using scanf type input program having user run program point program prompt file name c allows simple method obtaining command line argument requires modification declaration main void main int argc char argv parameter called argument count tell item string entered command line example argc second parameter called argument vector array pointer string string item entered command line argv point archive argv l point argv point argc argument added executable simple echo example echo typed command line void main int argc char argv int x x argc printf argument d x argv x note argv array pointer argv x pointer treated just like pointer character use function like strcpy strcmp numeric argument archive blah convert ascii string integer long integer float atoi atol atof function respectively possibility include printing direction argc added argument possible adding switch flag argument list argument presented order precisely compiler linker run directly ide summation command line argument handy quick way getting value program exercise alter previous program utilize command line argument scanf approach embedded controller conditional compilation suppose moment wish create version program differ mild way possible maintain multiple set source code pain come time fix bug add feature alteration need source file easier flag part source code belonging different version program compiler preprocessor work exactly conditional compilation exploit power preprocessor looked define directive way defining constant creating macro look following example fragment define ifdef char title version char title version endif endif directive act similarly command note parenthesis used block section need endif directive example char array title initialized version commented define version line title initialized version ides possible create variation project project define certain symbol way wouldn t define just select desired project variation note possible nest directive limited simply altering global declaration technique used code data fact entire function added excluded way typical use void func void code stuff ifdef debug printf error x endif rest function debug defined printf included executable defined printf existed exercise add debug printf statement existing program compile debug directive embedded controller embedded programming introduction mentioned earlier possible break computer programming broad camp desktop application embedded application embedded application market ubiquitous somewhat hidden average user typical person doesn t realize running embedded program using cell phone dvd player microwave oven certainly trapping normal computer generally exist instance s usually monitor keyboard speak programmer s perspective s different program development testing affected consider typical embedded application programmable intelligent thermostat unlike normal thermostat device allow home owner automatically change temperature different time day order save energy heat air conditioner running s home certainly device come monitor keyboard place small lcd display fixed message digit numeric display temperature input button programming set item plus comparison microwave oven probably complete numeric keypad series special function button multiple display possibly display short message case device far different standard desktop computer consequently programmer s approach input output processing different embedded case start unlikely printf scanf style function largely worthless world use printf output hardware bunch led input need read state switch pushbuttons possibly form level control rotary knob output need simply light led set value display fixed style message need single signal turn led advanced application alphanumeric display available setting individual letter possibility case chore handled setting clearing bit specific output input port microcontroller port set byte word port meaning behave input output depending register setting port little pin microcontroller hooked external circuitry port connected led circuit setting output port high light led setting port low turn led obvious question read write port case port memory mapped specific address memory map allocated given port read write just like variable development system disguise address global variable include library specific routine utilize port setting certain port let s port high simple reading port like consequently embedded code reading writing port branching requested chore embedded controller trick example know key pressed calling tell state switch connected port instant history simple momentary pushbutton instead toggle switch case like poll port waiting happen involves using simple loop repeatedly reading port state loop code break state change looping return course need monitor port typical ll need read value test form monitoring waiting happen called event loop evident house car probably filled device running event loop just waiting loop execute fairly fast time lag push resulting action noticed output end port normally stay value set need loop set complicated display seven segment device need create table value indicating bit pattern numeral letter displayed pattern word sent various port turn connected display variable input device volume control external device knob slider sensor connected analog digital converter adc separate circuit controller converter turn analog voltage numeric value read port example volume control just potentiometer connected fixed voltage knob moved voltage wiper arm change converter encode single byte byte range value volume maximum port read volume halfway port read finally volume math usually embedded code math intensive exception rule generally code microwave oven doesn t need like cosine function embedded system need floating point math math operation performed using integer table used speed processing case hear fixed point math versus floating point fairly simple idea suppose need work variable precision tenth integer simply treat variable having unseen decimal point digit think value tenth number stored manipulated result calculation say know real answer memory hardware embedded application just run piece code think program owning s sharing resource make life easy regard example s need operating known code running fixed hardware execution time predictable course computational power processor tends desktop world thing practical desktop world hardware variation classic example timing loop need create time delay waste certain time embedded controller external hardware simple loop iterates specific number time c loop doe count count require certain number clock cycle microcontroller specific time usually determined experimentally sit processor manual figure long loop s usually easier just write thing try value result depend specific microcontroller used clock frequency code development real kicker t native development embedded code word t program microcontroller just using microcontroller way create desktop application using desktop computer instead need host target host computer use development normal desktop unit target thing developing embedded application compiler use technically referred creates machine code processor host us example pc use pentium processor run creates machine code specific atmel vr microcontroller test code need simulate target host download compiled code target test extra unavoidable step embedded controller controller hardware architecture introduction arguably commercial microprocessor intel released bit processor comprised series ic year later intel released bit processor single chip remainder decade saw development numerous microprocessor microcontroller line various manufacturer including served core generation home computer performance impressive day pale comparison modern processor used clock frequency mhz region access modest amount memory typically megabyte integration electronic control everyday consumer item car microwave oven tv gained momentum time yielding microcontroller microcontroller thought specialized microprocessor typically computational power microprocessor instead feature functional block useful interfacing sensor actuator display device like consumer industrial electronics design particular microcontroller unique certain theme element consistent unlike microprocessor used personal computer microcontroller generally solution designed reduce cost save space example code data space requirement embedded application tend quite small compared traditional desktop application consequently memory included microcontroller confused cache memory microprocessor exists primarily increase computational speed unit microcontroller include functional block independent programmable timer general purpose digital gpio port analog input port featuring adcs bit resolution controller contain digital analog converter direct analog signal generation specialized block dealing serial communication wireless communication forth microcontroller large number interface block cost effective dedicate external ic pin input output function consequently pin usually multiplexed offering multiple possible us example specific pin programmed digital input digital output modulated output obviously simultaneously mentioned chapter processor use shared memory scheme code data v neumann architecture split memory scheme harvard architecture harvard architecture somewhat flexible allows faster processing processor fetch new instruction quickly collision data access case microcontrollers worth noting memory holding code control program cease exist power cycled major item importance architecture type instruction set used basic choice cisc complex instruction set computing risc reduced instruction set computing cisc processor contains instruction offer step rolled sound convenient instruction clock cycle execute comparison risc architecture use complex instruction instead focusing getting instruction execute single cycle usually pipelined meaning instruction executed instruction loaded program memory risc processor used simple embedded application cell embedded controller supercomputer example embedded risc processor atmel vr arm application tablet device smart phone game console game controller automotive controller vr core atmega processor used arduino controller board shall examine arduino following chapter atmel avr core atmel vr processor core us harvard architecture simple pipelining block diagram vr series core shown figure avr block diagram atmel embedded controller thing notice block interconnected bit data bus collection parallel connection case data bus bidirectional meaning data placed written block pulled read obviously form traffic control need applied usually handled appropriate timing signal state alu arithmetic logic unit responsible basic computational function integer addition subtraction bit operation comparison like association bit general purpose register alu performs operation value register directly value general memory example suppose want add variable place result variable alu transfer value memory register computation performed transfer result final location large number register common feature risc processor early cisc processor register single accumulator sort operation specialized register shown associated io module timer forth moment important specialized register status register program counter stack pointer program counter pc keep track currently executing instruction current location code flow stack pointer sp record current memory address stack location memory used temporary variable status register sr contains series bit reflecting recent result alu operation general state processor vr status register contains bit initialized functionithsvnzc figure avr status register atmel bit follows atmel documentation bit global interrupt enable global interrupt enable bit set interrupt enabled individual interrupt enable control performed separate control register global interrupt enable register cleared interrupt enabled independent individual interrupt enable setting cleared hardware interrupt occurred set reti instruction enable subsequent interrupt set cleared application sei cli instruction described instruction set reference bit t bit copy storage bit copy instruction bld bit load bst bit store use source destination operated bit bit register register file copied t bst instruction bit t copied bit register register file bld instruction bit h half carry flag half carry flag h indicates half carry arithmetic operation half carry useful bcd arithmetic bit s sign bit s n v exclusive negative flag n s complement overflow flag buffer simply repeat input signal output like ordinary buffer offer high z state high z state enabled output signal present output impedance buffer go high value effectively disconnecting buffer bus embedded controller v s complement overflow flag s complement overflow flag v support s complement arithmetic bit n negative flag negative flag n indicates negative result arithmetic logic operation bit z zero flag zero flag z indicates zero result arithmetic logic operation bit c carry flag carry flag c indicates carry arithmetic logic operation figure avr status register bit atmel important remember state status register saved entering interrupt routine restored returning interrupt handled software shall handled future chapter memory important aspect memory note vr contains different kind memory including flash program memory static data memory sram static random access memory eeprom electrically erasable programmable memory typical embedded application run single program repeatedly program run moment device turned turned application program updated microwave oven application updated qualified technician consumer example automotive engine management consequently program memory need able survive power historically rom memory prom programmable memory individual bit set cleared use link difference rom programmed time manufacture prom programmed manufacture permanent reprogrammed rom expensive large production run expensive small quantity eeprom advantage erasable form storage flash ram similar expensive downside programmed block eeprom flash ram called nvram ideal storage medium main program eeprom useful medium storing data survive power cycle possible example use eeprom involve saving user preference setting digital camera power turned user expects device left reverting default state typically special instruction procedure needed write read eeprom contrast flash ram eeprom sram volatile just like common dram dynamic ram variant personal computer static ram typically transistor arranged flop bit storage dram comparison typically consists single combination bit sram dense expensive bit dram fast doe need refreshed charge dram cell leak time requiring cell refreshed regular interval result sram used general purpose register special register atmega used arduino uno development board feature byte embedded controller flash ram eeprom sram uno detailed following chapter comparison atmega consists flash byte eeprom byte sram clearly modest memory footprint compared personal computer sufficient power wide range application mean heap speak controller boast megabyte addressable memory need specify controller given embedded application extra memory go unused make application faster merely lead expensive hardware continuing register vr core memory mapped tied specific address sram example high adch low adcl byte s analog digital converter output address similarly output port b portb address data direction register port b ddrb detailed table register atmel documentation register summary portion available appendix finally series block interrupt unit io module complete design shall closer look block upcoming chapter embedded controller controller avr atmega overview controlablanca film noir microcontroller need rick peered work bench wasn t dame walked lab real looker beautiful intelligent woman way turning life burning hell potential forest heel damn cussed shook finger blistering unfortunate collision hot soldering iron rick sidled somewhat wary s sure kind woman make ingrid bergman look bad best day demeanor rick assumed grad polytechnical institute confident tall slender longest leg rick seen hip way floor companion frankie lab rat say possibly want little lab er mean stammered ve got problem said voice husky pull dog sled ve got control issue need expert eh think know did say didn t responded s miss rick furrowed brow missy missy just miss c came curt reply rick looked shoulder lab partner frankie going hall visit italian finish prototype don t bogart scope cause louie need turned dame follow said walked hall silence came door small red white green flag sticker rick knocked door opened revealing young man dark hair day old beard perfectly trimmed edge inside office sat large framed photo ferrari postcard san marino appeared spare part manner medieval coffee machine si said young man eyebrow raised looking like cross gq model spock arduino missy said rick che came young man s response kay c said dame arduino looked asked casey sensed possible language barrier tried meet halfway miss c si said missy c nodded arduino replied exasperation increasing cc compiler arduino getting confused nazi asked eye scanning hallway dame tried different approach ok suppose mother s sister d aunt c countered yeah mother s sister d antsy added rick dame moved close arduino whispered clenched teeth look just miss c got said arduino come help miss seesi rick shook head lowered gaze ground script devolved bad parody abbott costello routine pun liking surely d warn brother lab college university world did walk problem miss seesi asked arduino dame beginning headache kind build eye feel like skull filled monkey playing dodge ball took deep breath exhaled slowly ve got application s trouble said trouble thought rick yeah ll bet dame know trouble s package one dna bug d regular venus flytrap beautiful familiar film classic casablanca starring humphrey bogart ingrid bergman film noir genre strongly suggested watch movie film noir title proceeding attitude expressed necessarily author embedded controller arduino clasped hand smiled trouble trouble ve come right place tell ve got control bunch device led motor actuator usual crew started ve got obtain information person running know kind real operator lot setting pushbuttons switch potentiometer megillah tell ya m arduino walked office nibbled biscotti turned biscuit fingertip held softly way orchestra conductor balance baton said head slightly raised cocked revealing beginning knowing smile need flexible expandable inexpensive piqued dame s couldn t let yes yes doe responded coolly case said arduino allow introduce uno tossed remnant biscotti rick picked small blue printed circuit board containing ic bunch header numbered pin looked like usb power connector pretty spiffy said arduino s eye lit s open source microcontroller development board say open source mean software hardware software distribution includes extensive example complete library source code data want s vr came dame s reply vr line microcontrollers atmel uno us atmega programmable flash memory sram data memory eeprom general purpose register pipelined reduced instruction set computer harvard architecture instruction require tick mhz arduino s concentration broken hissing sound coming large stack book ahhh cup espresso asked lunch said rick knew arduino s concoction bouncing wall afternoon miss seesi arduino queried maybe just relied arduino smiled cappuccino embedded controller steaming beverage looked board intently labeled port pin header pretty small sure handle job asked problem said arduino pulled couple slightly crumpled piece paper stack placed desk block diagram used uno second detailed schematic board embedded controller controller ve got access io port began b c digital io programmable resistor io memory mapped read write external device just ordinary variable using c programming language universal usart programmed communicate host computer interrupted send text forth make debugging pretty bet said arduino obviously getting excited ve got bit analog digital converter channel bit bit plus output generate pulse width modulation interrupt asked ll need multiple level said arduino internal external s reset button power asked multiple option said arduino power usb cable know usb supply ma device ma enumerated device s plug external supply kind hook regulated volt source supply power relay motor d power big wire item course need run current board trace choose uno intelligently figure power dame getting interested needed great chip deliver know fan generally speaking arduino began io pin sink source ma entire microcontroller limited ma total draw stay thermal limit obviously t drive bunch pin maximum current capability time big deal s make drive circuit right rick dame nodded knowingly office silent peered little board dame looked programming interface command line ide arduino waved hand responded ide run window mac o linux bypass want command line fine fine interrupted library s straight jacket right insisted arduino s nice library use little want insert assembly op assembly op code thought sent shiver rick s spine spent month day trying debug device driver written assembly arduino holding sound good giving story asked s catch catch replied arduino s thing small thing bite dame raised eyebrow demanded like controller arduino began vr us memory mapped io address writing port example write portb light dame responded s true said arduino come reading physical pin use different address case pinb instead reusing wait stammered dame s physical pin write use portb read use pinb don t confuse pin port said arduino look melancholy crept face remember port just port pin just pin fundamental thing apply clock tick dame shaken started look got ta io straight understand said arduino expression grew looked squarely got ta plain ll regret maybe today maybe tomorrow soon rest life hand brushed lightly uno turned wiping tear eye headed office door rick embedded controller walked briskly hall distance past lab silhouette disappeared fog mysteriously formed accompanied dull roar s idling engine s got uno said rick arduino nodded yes know ve got plenty came need good lab tech help build prototype project falcon using interested wry smile grew rick s face falcon maltese yes yes came response arduino rick said think beginning beautiful complete information arduino uno development board http arduino language reference http arduino tutorial info http arduino software downloads http doubt just http start looking embedded controller bit piece include define introduction welcome bit piece catchy eh sequence chapter delf variety aspect programming atmel vr atmega microcontroller arduino uno board associated library focus io programming specifically ll looking way coding interface uno external circuitry hardware aspect dealt separately lab exploring io code used read write digital analog port perform task reading state switch lighting led reading continuously variable data force temperature timing counting event controlling device motor simplest way performing item library function come arduino function fast efficient need use platform reason ll diving library function work uninitiated scouring library source code daunting task think bit piece series guided tour covering major part library granted s probably fun say series guided tour tropical island south pacific tuition little doubt interesting us embedded controller said island field trip right thing need examine commonly used include file recall include file known header file one end used collect function prototype reference global variable structure definition wonderful confusing defines remember c language fairly skinny function written come library prototype function library s header file interesting twist library function aren t function instead simply inline expansion defines different library available make life easier system include master include file contains directive reference include file boy professional programmer constantly looking way make keystroke count universal stuff common controller let s start biggie line part omitted ifndef define include include include include include include include define high complete detail library lot goody including example code reference page particular prove useful embedded controller define low define true define false define input define output define define pi define define define define line prevent accidental file included won t included d bunch redefinition error selection commonly used library header file series constant definition s crazy following series look like function inline expansion preprocessor replaces function different bit code inline expansion incur overhead function call run faster use memory notice make use ternary construct min make use recently defined constant radian nointerruprs perform substitution perform substitution case cli function turn single assembly language instruction turn interrupt globally define min b b b define max b b b define ab x x x x define constrain amt low high amt low low amt high high amt define round x x long x long x define radian deg deg define degree rad rad define sq x x x define interrupt sei define nointerrupts cli define clockcyclespermicrosecond typedefs shorthand unsigned bit integer unsigned char typedef written header file notice new typedefs based original typedef fourth line unsigned char declared merely boolean byte finally unsigned int declared word define lowbyte w w define highbyte w w typedef boolean typedef byte typedef unsigned int word common procedure io programming include checking setting clearing specific bit special register typically bitwise math operator example want set bit register called ddrb leaving bit intact d bitwise embedded controller ddrb define specific bit position like define ledbit define motorbit define alarmbit want set bit motor write ddrb ddrb motorbit word left shift zero bit location place resulting bit high register content little cumbersome unless turn function bitset ddrb motorbit s pretty easy obvious check line define bitread value bit value bit define bitset value bit value bit define bitclear value bit value bit define bitwrite value bit bitvalue bitvalue bitset value bit bitclear value bit define bit b b file come bunch function prototype item using void pinmode void digitalwrite int digitalread int analogread void analogreference mode void analogwrite int unsigned long millis void unsigned long micros void void delay unsigned long void setup void void loop void particularly important arduino development main function make call setup loop ll writing primary entry point embedded controller controller specific stuff moving header file recall dozen dozen model given processor series like vr controller different memory capacity io capability forth need distinguish using trying code generic possible normally creating specific header file controller ide give option select controller using defines controller id list arduino ide tool board consider following chunk ifndef define include huge series conditional includes looking processor symbol set arduino ide defined include elif defined include elif defined include atmega arduino uno elif defined include continue end elif defined include defined warning device type defined endif endif include include include endif s ask includes bunch thing make programming life easier definition port register bit going seeing ifndef define embedded controller register associated bit number bit input port associated bit define pinb define define define define define define define define bit data direction register associated bit define ddrb define define define define define define define define bit output port associated bit define portb define define define define define define define define port c analog digital converter adc goody ifndef define adc endif define adcw define adcl define define define define define define define define embedded controller define adch define define define define define define define define define adcsra define define define define adie define adif define adate define adsc define aden define adcsrb define define define define acme define admux define define define define define adlar define define remainder header file ok just nugget define portb controller communicate io external pin written read ordinary memory location want write port simply declare pointer variable set value appropriate address manipulate needed atmega address io port b write following wanted set bit high unsigned char portb portb unsigned char cast required compiler quiet portb portb use bit setting function seen earlier little clearer bitset portb embedded controller problem declare use pointer variable little clunky s business pointer assignment statement variable beginning programmer tend forget requires look specific address port change use processor make thing generic place address typically offset base address header file header file declares item portb convenience defined s function s defined follows define defined word item base offset address meaning s address saw earlier heck look little weird glance define volatile just cast pointer say item pointer unsigned char don t forget earlier typedef placing item header file ve managed make io programming generic time removing need pointer variable declaration need pointer want set bit high just say portb portb typically portb bitset portb note lack line code business exactly portb located memory map hidden accidental error leaving code work different processor s operationally efficient dealing pointer consequently normally use symbolic register port name hard address future work simply lovely time snack fruity reminds tropical wondering volatile recall modifier indicates variable changed process possibly interrupt prevent overly aggressive assembly code optimization compiler embedded controller controller bit piece digital output circuitry introduction fully appreciate software interface microcontrollers gain insight interface controller external device useful examine underlying circuitry chapter shall investigate basic digital output circuitry controlled simple logical input target controller usually limited output current voltage capability control device power transistor turn control demanding load simplified diagram general purpose gpio circuitry seen figure figure gpio circuitry atmel embedded controller circuit represents single bit io port consists bit typically circuitry replicated seven time accommodate single port order reduce external pin count ic pin multiplexed function multiplexer shown schematic pxn far left schematic represents physical output pin data bus shown right edge source data written physical pin destination data read pin shall focus writing output examine input functionality later chapter circuit specific atmega series representative gpio circuitry microcontrollers output circuitry figure present simplification focusing solely output portion figure output circuitry simplified atmel embedded controller pud pull disable sleep clk clock control line common bit port ignore purpose lowest section removed involved input functionality go upper section surrounding mosfet finally series gate inverter multiplexer clustered middle section removed serve particular somewhat esoteric function ability rapidly toggle bit section needed typical functioning simplification left circuit center d buffer primary signal wdx wrx feed ddxn portxn ddxn data direction bit determines physical pin configured output writing input reading portxn present data need written note x refers port letter port b n refers bit number port physical pin bit number port b denoted alternately collection bit ddxn referred data direction register ddr data direction register port b referred ddrb port register mapped memory port b ddrb direction control portb writing data pinb reading later similarly ddrc portc pinc port c port controller b c d atmega understand circuit work recall d s q output simply echo logic level present d input control signal transition low high positive edge trigger note output portxn feed buffer turn feed physical pin order write data pin logic high placed data bus wdx signal pulsed transfer logic high q ddxn high level enables buffer connected pxn port bit configured output stay mode wdx desired data high low bit placed data bus wrx signal pulsed transfer logic level q portxn feed transfer data bit output level remain wrx wdx wrx output pin level change order write new data output pin desired data bit placed bus wrx pulsed necessary ddxn wdx time example suppose wish flash led time attaching led pin toggling pin high low repeatedly write high ddxn establish output write mode write high portxn turning led short wait write low portxn turning led short wait write high portxn turning led continue process like manner flash need final buffer associated rdx rrx signal allow read current state direction port bit embedded controller controller bit piece digital input circuitry introduction chapter shall investigate basic digital input circuitry used sense state external switch device device active generating high low voltage simple passive switch connecting ground use optional internal resistor simplified diagram general purpose gpio circuitry seen figure previous chapter single bit shall remove section pertinent input function enhanced clarity figure gpio circuitry atmel embedded controller input circuitry figure present simplification focusing solely input portion figure input circuitry simplified atmel removed gate surrounding portxn create bit toggle function removed pud sleep clk signal simplified lower section leaving just schmitt trigger read process similar write process examined previous chapter read signal external pin need write logic low data direction bit ddxn disconnect portxn physical pin pxn buffer state embedded controller left connected external device wind trying drive active output portxn produce unpredictable result best portxn disconnected pxn signal existing pxn drive schmitt trigger located edge diagram signal passed data bus rpx read pin x control signal asserted lower buffer schmitt trigger used intermediary certain clean input signal note input signal read pin register pinb pinc contrast port register used writing data want write data outside world write port register want read data outside world read pin register microcontrollers use naming convention use single port register writing reading good mnemonic remembering pin port used input output associate pin o output port typically port pin ddr register adjacent memory map example using port b pinb ddrb portb check register map appendix left mosfet section used generate optional resistor basic way generate input signal active circuit example output logic gate connected external pin voltage produced gate fed schmitt trigger described previously signal make way data bus convenient generate external voltage active circuit wanted read state simple push button couldn t just connect pin ground signal sense instead d connect external power supply limiting resistor requiring component space take care activated mosfet connects associated resistor internal power line switch connected external pin ground closed pin pulled ground logic low switch opened resistor pull pin voltage supply rail logic high determine state switch external circuitry activate pin input mode ddxn logic low feed gate output portxn logic high signal drive gate s output high turning mosfet engaging resistor little odd writing port bit read mode just neat way making available hardware read mode port register unused let waste require register control summary read external pin low written appropriate ddr bit placing circuit read input mode desired high written appropriate port bit desired low written port bit external value read pin register output circuitry ddr port rewritten prior subsequent read pin d hold value rewritten maintaining current data direction status embedded controller embedded controller bit piece pinmode programming port direction bicycle tour going start looking digital io digital io allow read state input pin produce logical high low output pin example include reading state external switch turning led motor potential external connection microcontroller outside world dedicated wire pin count controller package huge atmega uno board bit port plus connection power ground like physical pin possible simple ll multiplex pin make multiple us example look bit io port b lead single external pin pin programmed behave input read mode output write mode general bit port programmed independently input output obviously use port need tell controller way behave arduino usually library function pinmode description function pinmode description configures specified pin behave input output description digital pin detail functionality pin arduino possible enable internal pullup resistor mode additionally input mode explicitly disables internal pullups syntax pinmode pin mode parameter pin number pin mode wish set mode input output digital pin page complete description functionality return figure pinmode doc http embedded controller d think term arduino pin number instead port bit number table arduino uno pin designation versus atmega port pin naming arduino designatorgeneral purpose io designatorcomment bit input bit input bit input bit input bit input bit input bit bit bit bit bit bit bit bit bit bit bit bit bit bit led figure arduino uno pin definition naming convention reasonably logical perfect note designators analog input remaining digital io fact predefined global constant map numeric value uno file detail noted analog channel controller produce continuously variable analog voltage say s impossible analog control just s going little work shall soon practically speaking pin naming convention isn t bad pin labeled right board figure embedded controller arduino uno example directly arduino uno logo spot pin located edge pin header according table bit port set connector output mode drive external circuit write pinmode output ok using controller faster way accomplish code let s look code function s file called relevant bit piece slightly altered make portion little clear void pinmode pin mode bit port oldsreg volatile reg bit digitalpintobitmask pin port digitalpintoport pin port return bad pin requested reg portmoderegister port portoutputregister port embedded controller mode input oldsreg sreg cli reg sreg oldsreg mode oldsreg sreg cli reg bit sreg oldsreg output mode oldsreg sreg cli reg bit sreg oldsreg figure pinmode code declaration local variable specified arduino pin number decoded port associated bit mask function pin specified doe exist particular processor port set error value check bail s s port bit mask s just bit value desired bit position s complement depends intend set clear function perform similar decoding operation example port mode register better known data direction register ddr atmega ddrb ddrd setting bit set mode output write clearing put input read mode function really table disguised function s merely access array filled appropriate value accessing array faster calling function consider portmoderegister function given port designator return actual data direction port manipulate ddrc defined define portmoderegister p volatile p embedded controller turn filled error symbol address appropriate data direction register const progmem ddrb ddrc ddrd special function used read value program space versus normal data space remember controller us harvard architecture split memory end result ll address required data direction register s ll need access order set input output mode chunk code just possibility mode request let s look output mode oldsreg sreg cli reg bit sreg oldsreg probably single important register microcontroller status register called sreg contains bunch flag bit signify series state example bit indicate arithmetic operation overflowed bit hold result s bit indicate result negative forth bit control respond interrupt interrupt high priority event halt interrupt execution code interrupt code isr interrupt service routine run instead interrupt occur time code middle important prevent happening save current content status register clear status bit enables interrupt occurring s cli turn expansion single assembly instruction called guessed cli know won t interrupted fiddle ddr reg ddr particular port bit mask word set bit selects direction output finally restore original content status register enabling interrupt assuming set begin originally wrote pinmode output function decoded arduino pin bit port b portb determined corresponding ddr ddrb bit mask ored content ddrb selecting direction bit output mode embedded controller clause input mode similar mode input oldsreg sreg cli reg sreg oldsreg note ddr anded complement bit mask clear bit placing input mode code clear bit output register disables resistor external pin contrast note mode set bit great stuff sure using arduino need quicker don t interrupt code running safely twiddle directly port ddr remember wanted make bit port b ready output mean need set bit ddrb ddrb use macro bitset ddrb trick probably little clear error prone s useful remember need set bunch pin entire port input output mode using pinmode d make individual call pin contrast needed set bit port b output just ddrb set uno pin output mode doe mean use pinmode seen function tie perfectly arduino uno board robust flexible s just bicycle serve better motor vehicle s good option order write value port parallel fashion bit time example feed parallel input dac embedded controller bit piece digitalwrite writing port implies wish control external device involve setting clearing single bit turn led motor set bit required example send ascii code write data word external digital analog converter dac important remember microcontroller limited current available pin ma pin atmega ma total chip possible drive handful led ma direct connection consisting current limiting resistor led possible turn relatively small dc motor higher current voltage load require manner driver interface circuit forgo discussion just focus code portion output port pin high low state referred digital output possible generate analog signal pulse width modulation additional external circuitry digital nature port pin generally speaking microcontrollers produce continuously variable analog voltage port pin exception example arduino board utilizes atmel arm cpu contains internal bit dacs writing port set proper direction mean using pinmode associated data direction register ddrx set mode output consider writing data external device single port bit s required pinmode straightforward robust bit need controlled easier directly ddrx just method set output mode true writing data effective method single bit set bit write single bit digitalwrite function good choice documentation http http embedded controllersdigitalwrite description write high low value digital pin pin configured output pinmode voltage set corresponding value board high ground low pin configured input writing high value digitalwrite enable internal pullup resistor tutorial digital pin writing low disable pullup pullup resistor light led dimly led appear work dimly likely cause remedy set pin output pinmode function digital pin harder use digital input digital pin led resistor attached soldered board board enable internal resistor hang v instead expected onboard led series resistor pull voltage level meaning return low use pin digital input use external pull resistor syntax digitalwrite pin value parameter pin pin number value high low return example int ledpin led connected digital pin void setup pinmode ledpin output set digital pin output void loop digitalwrite ledpin high set led delay wait second digitalwrite ledpin low set led delay wait second figure digitalwrite doc example code pretty easy use simply set direction write appropriate arduino pin designator remember pin designators number written header uno board port bit number atmega reference note regarding arduino pin worth pin hardwired surface mount signaling led located right said pin mean total source current available pin somewhat reduced led current applied arduino pin portb bit written shorthand just doe digitalwrite function code digitalwrite slightly cleaned viewing original file embedded controller digitalwrite pin val timer bit port oldsreg volatile timer digitalpintotimer pin bit digitalpintobitmask pin port digitalpintoport pin port return timer turnoffpwm timer portoutputregister port oldsreg sreg cli val low bit sreg oldsreg figure digitalwrite code let s apart piece piece bit bit initial data declaration group function call serve translate arduino pin designator appropriate atmega port bit timer timer business ll address shortly section finish error check specified pin doesn t exist function bail doe timer digitalpintotimer pin bit digitalpintobitmask pin port digitalpintoport pin port return vr series controller like controller contain internal allow controller precisely time event produce pulse signal specifically pulse width modulation arduino available output timer use analogwrite function pin ability need translate arduino pin associated timer digitalpintotimer function closer look timer later important understand associated timer need turned use basic digital write function timer turnoffpwm timer code turn pwm functionality little statement cbi used clear specific bit port case associated control register tccrx info http vr embedded controller void turnoffpwm timer switch timer case cbi break case cbi break case cbi break case cbi break case cbi break case cbi break specified arduino port translated output register portx portoutputregister port seen pinmode status register saved global interrupt bit cleared disable interrupt cli desired port portx anded complement bit mask clear set low ored bit mask set set high status register restored original state oldsreg sreg cli val low bit sreg oldsreg s pretty want write bunch bit group output port connection simply look corresponding port arduino pin portx set clear directly example want clear bit port b following assuming timer active portb clear bit set portb set bit leave bit completely untouched contrast suppose want set bit binary pattern s equivalent following portb portb chunk clear bit trailing set binary pattern preferable clearing bit setting bit cause distinct set output voltage pattern external pin granted set exist short time create problem application embedded controller bit piece delay waste time code need wait thing time event example want turn led second turn ve seen control led digitalwrite wait second simple method create loop loop really doe waste time example know simply incrementing testing branching loop take microsecond write function like void cheesydelay unsigned long msec volatile unsigned long unsigned long endmsec msec endmsec note specify number millisecond d like waste iteration loop take microsecond multiply achieve millisecond volatile modifier important tell compiler aggressively optimize code changed code running example interrupt compiler figure achieve end result ignoring loop doing simple addition problem function resulting delay highly dependent microcontroller used clock frequency just need quick dirty delay work fine far accurate delay available delay function sibling delaymicroseconds reference material repeated delay description pause program time miliseconds specified parameter millisecond second syntax delay m parameter m number millisecond pause unsigned long return http embedded controller int ledpin led connected digital pin void setup pinmode ledpin output set digital pin output void loop digitalwrite ledpin high set led delay wait second digitalwrite ledpin low set led delay wait second caveat easy create blinking led delay function sketch use short delay task switch debouncing use delay sketch significant drawback reading sensor mathematical calculation pin manipulation delay function effect brings activity halt alternative approach controlling timing millis function sketch sited knowledgeable programmer usually avoid use delay timing event longer s millisecond unless arduino sketch simple certain thing delay function controlling atmega chip delay function doe disable interrupt serial communication appears rx pin recorded pwm analogwrite value pin state maintained interrupt work delay example delaymicroseconds description pause program time microsecond specified parameter thousand microsecond millisecond million microsecond second currently largest value produce accurate delay change future arduino release delay longer thousand microsecond use delay instead embedded controller delaymicroseconds parameter number microsecond pause unsigned int return caveat known issue function work accurately range microsecond assure delaymicroseconds perform precisely smaller arduino delaymicroseconds longer disables interrupt figure delay doc function tied function micros millis repeated millis description return number millisecond arduino board began running current program number overflow zero approximately day parameter return number millisecond program started unsigned long tip note parameter millis unsigned long error generated programmer try math datatypes ints embedded controller description return number microsecond arduino board began running current program number overflow zero approximately minute mhz arduino board duemilanove nano function resolution microsecond value returned multiple mhz arduino board lilypad function resolution microsecond parameter return number microsecond program started unsigned long figure millis micros doc function rely arduino configuring timer moment board reset used generate interrupt counter overflow time overflow predetermined time based clock speed interrupt turn update global variable track long program running let s consider initialization code definition global variable declaration timer init code set timer pulse width modulation duty analogwrite function code reasonably commented presented explanation save reminder sbi macro reduce single assembly language instruction set specific register bit include prescaler set tick clock cycle overflow handler called tick define clockcyclestomicroseconds number millisecond overflow define fractional number millisecond overflow shift right fit number byte clock speed care mhz doe lose precision define define volatile unsigned long volatile unsigned long static unsigned char embedded controller init need called setup function wo work sei set timer prescale factor sbi sbi enable timer overflow interrupt sbi timer used hardware pwm better motor ensures waveform note fast pwm mode achieve frequency mhz mhz clock duty cycle set timer prescale factor sbi sbi timer phase correct pwm mode sbi set timer prescale factor sbi configure timer phase correct pwm sbi set prescale factor mhz khz inside desired khz range xxx work properly clock speed code use determine prescale factor sbi adcsra sbi adcsra sbi adcsra enable conversion sbi adcsra aden bootloader connects pin usart disconnect used normal digital reconnected figure timer setup code embedded controller let s look interrupt service routine time counter overflow bit counter try increment wrap generates interrupt call function basically doe increment global variable declared earlier signal copy local variable stored register volatile var read memory access unsigned long m unsigned char f m f f f m f m figure timer interrupt code guess millis micros function access global variable return value interrupt occur process value status register sreg copied status register s global interrupt enable bit cleared cli access performed plus little extra calculation micros status register returned prior state retrieved value returned caller unsigned long millis unsigned long m oldsreg sreg disable interrupt read inconsistent value middle write cli m sreg oldsreg return m embedded controller long micros unsigned long m t oldsreg sreg cli m t t sreg oldsreg return m t clockcyclespermicrosecond figure millis micros code delay function pretty straightforward simply retrieves current time reset go busy wait loop constantly checking rechecking time difference reach requested value void delay unsigned long m start start micros m micros start m start figure delay code way just slightly sophisticated version initial cheesy delay function precise us accurate internal counter operating known clock frequency microsecond version delay little trickier especially short delay doe busy wait doe using assembly code delay particularly accurate period microsecond comment instructive embedded controller delay microsecond assumes mhz clock void delaymicroseconds unsigned int mhz clock arduino board delay simply return overhead function yield delay approximately return following loop take quarter microsecond cycle iteration execute time microsecond delay requested account time taken preceding command busy wait sbiw cycle brne cycle figure delaymicroseconds code major problem using delay noted documentation busy wait loop work controller effectively spinning wheel effective way delay make direct use millis function basic idea check time using millis need inside loop checking elapsed time iteration snippet example code unsigned long currentmillis previousmillis intervaltowait intervaltowait passed variable global define initialize current time previousmillis millis currentmillis millis currentmillis previousmillis intervaltowait need currentmillis millis essence ve built kind busy wait loop requisite code inside embedded controller bit piece digitalread introduction discussion follows deal strictly logic level sensing continuously variable analog signal bit piece entry covering analogread pinmode function directly accessing appropriate data direction register bit ddrx general purpose io connection configured read state external switch logic level arduino uno volt represents logic high volt represents logic low added capacity atmega uno ability include optional internal resistor input pin allows connection simple passive switch input pin float high switch open go low switch engaged read individual pin input arduino offer digitalread function multiple pin read simultaneously directly accessing appropriate register examine afterward copy online documentation digitalread function digitalread description read value specified digital pin high low syntax digitalread pin parameter pin number digital pin want read int return high low example int ledpin led connected digital pin int inpin pushbutton connected digital pin int val variable store read value void setup pinmode ledpin output set digital pin output pinmode inpin input set digital pin input void loop val digitalread inpin read input pin digitalwrite ledpin val set led button value http embedded controller pin value pin input note pin connected digitalread return high low change randomly analog input pin used digital pin referred digital pin figure digitalread doc slightly version source code follows file int digitalread pin timer bit port timer digitalpintotimer pin bit digitalpintobitmask pin port digitalpintoport pin port return low timer turnoffpwm timer portinputregister port bit return high return low static void turnoffpwm timer switch timer case cbi break case cbi break forth available timer shown figure digitalread code embedded controller line convert arduino pin designator appropriate atmega port bit number timer port invalid function exit timer digitalpintotimer pin bit digitalpintobitmask pin port digitalpintoport pin port return low timer important arduino preconfigures uno s timer use analogwrite function pulse width modulation scheme affect possible pin proper operation digital read timer need turned saw bit code inside digitalwrite function timer turnoffpwm timer point content input register read direct input register pinx anded requested bit remove bit return simple high low portinputregister port bit return high return low function used turn pulse width modulation timer little statement specified arduino pin hooked timer internally timer switch statement cbi executed appropriate control register cbi function translates single assembly language instruction clear specified bit control register turning timer static void turnoffpwm timer switch timer case cbi break case cbi break case cbi break case cbi break case cbi break case cbi break application bit need read example reading parallel data performed direct access appropriate pinx register pinx like fraternal twin portx register portx used write digital data external connection pinx read digital data external connection just output port register d input pin register microcontrollers configured way use register reading writing function controlled associated data direction register directly access single bit connected pin clear desired data direction register bit activate input mode second desired set bit associated port embedded controller enable optional resistor don t want leave bit clear finally read desired bit pin register bit mask remove bit example read bit binary port b ddrb activate input mode portb enable use bitset macro bitset portb value pinb retrieve data minor work alter multiple bit read bit resistor bit pattern ddrb activate input mode portb disable value pinb retrieve data bit want bit separately pinb retrieve data bit pinb retrieve data bit practical example switch let s look implement switch switch work circular manner stepping sequence setting returning start sequence completed example shall consider single momentary contact pushbutton cycle series fan speed low medium high start state successive press button advance state low high high reached press cycle state process continues like manner speed setting indicated led led given time code clean examine pushbutton led portion code consider control speed fan shall assume appropriate hardware debounce circuit incorporated pushbutton schmitt rc network depressing button produce logical high arduino input pin led driver assumed active high high output pin arduino light led thing remember typical microcontroller capable checking state input pin fraction microsecond consequently simply check pin logical high cycle fan speed fraction second human press release button microcontroller loop pin checking code thousand time cycling fan speed loop s check final fan speed s guess instead need look low high transition happens button press point need switch debouncing single press result dozen low high edge switch contact chatter resulting random fan setting way perform positive going edge detection use variable current state switch second prior state switch state measured immediately prior current state current state high pressed prior state low pressed know detected positive going edge perform processing note iteration loop current state high prior state high current state prior loop iteration processing performed point matter long user kept finger button current prior state high user embedded controller release button current state low prior state high negative going edge need process loop iteration produce current prior state low need process eventually user press button ll current state high prior state low ll process edge ll need variable state current prior pushbutton state led indicate fan speed pushbuttons thought boolean variable led variable range high simplicity ll use globals unsigned char nicely led positioned arduino uno pin pushbutton connected pin setup function set proper direction port bit require separate call pinmode simple operation operate directly beginning portion declare state variable initialize unsigned char unsigned char unsigned char define value state conveniently chosen bit position portb define define define define declare bit mask led bit pushbutton define define define define define pbutton mask defined like define convenience define setup set output ddrb set input ddrb light led portb default output reason led sure set continuing portb embedded controller looping code need check proper current state pair need turn existing led check current state increment state light led couple way obvious solution using construct second method bit compact pun intended loop current button state currentstate pinb pbutton positive going edge currentstate priorstate switch ledstate case portb turn old led portb turn new led ledstate increment speed break case portb portb ledstate break case portb portb ledstate break case portb portb ledstate break update state loop iteration priorstate currentstate alternate version page note code saving instead checking fan state turn led increment fan state state increment past maximum make sure set state new state tell led light version work little code way chose bit position possible desirable handy technique time time embedded controller current button state currentstate pinb pbutton positive going edge currentstate priorstate increment new state ledstate ledstate lazy turn led portb turn new led portb ledstate update state loop iteration priorstate currentstate exercise closing s interesting question switch numerous state say dozen single increment button prove little frustrating user example accidentally past desired setting forced way effectively alleviate add decrement pushbutton alongside existing increment pushbutton code example presented need altered respond button configuration appears daunting challenge break part initially consider preceding code need altered order change operation fan speed increment button fan speed decrement button instead button push producing sequence implement button produce completed determine combine new implementation existing example code embedded controller http embedded controller bit piece analog input circuitry introduction useful digital port need continuously variable analog port controller course inherently digital device doesn t mean analog signal bound considerable variation available given microcontroller unit analog digital digital analog circuitry added controller peripheral device particularly true expensive controller specialized application require extreme performance example high definition digital audio recorder playback device general purpose controller analog digital converter adc include digital analog converter dac resolution speed converter vary quite bit controller controller chapter shall focus adc atmega series discussion quite specific concept presented apply controller manufacturer performance operational detail differ typical use adc capture value external sensor user input device particular point time instance wish measure output voltage temperature light sensor regarding user interface device possibility measure voltage developed potentiometer outer terminal connected power ground wiper attached analog input port user rotates pot voltage shift voltage represent manner variable loudness setting music playback speed motor sort application considered snapshot single conversion us don t spend time continuously converting port voltage digital value way say waveform capture device case like temperature sensor simply perform conversion need user interface device long obtain value sufficiently fast rate control appear continuous user application require dozen conversion second compared ten thousand conversion second like digitizing audio signal course need user interface device consider common stereo receiver typically knob volume balance bass treble forth impractical single knob control series button alongside indicate current function knob alternately industrial setting need monitor temperature location environmental parameter use adc make far sense use single adc multiplex external pin think multiple input channel select channel sensor want make measurement continue say use snapshot mode application require continuous monitoring external signal technique obtaining measurement consequently adc system configured single conversion conversion triggered event demand circuitry programming interface analog input tends involved flexible ve seen digital input example adc system register bit devoted specifying parameter sample acquisition mode conversion speed data justification pin muxing forth embedded controller atmega adc block diagram atmega adc figure figure adc circuitry atmel embedded controller heart single successive approximation dac bit resolution maximum conversion speed resolution k sample second clearly insufficient application cd quality audio video fast sensor user interface monitoring converter performance specification include lsb integral error lsb absolute accuracy reference available external reference used converter includes stabilize measurement rapidly changing input signal channel mux channel used package package used standard configuration arduino uno board us input circuitry optimized source output impedance k important recognize unipolar respond positive voltage signal measured bipolar manner dc level shifting required register associated adc shown figure registerbit figure adc register adcsra adcsrb control status register bit description enable set enable start conversion set start conversion conversion complete hardware reset bit zero writing zero bit effect auto trigger enable set auto trigger mode rising edge selected trigger signal start conversion trigger source selected adts bit adcsrb register interrupt flag used interrupt mode bit set conversion complete data register updated bit cleared hardware executing interrupt handler routine use adie interrupt enabled set enable adc conversion interrupt use adif prescaler bit bit used divide clock adc clock yield division increasing value double clock divide yielding divide analog comparator multiplexer enabled setting bit allows multiplexed adc pin replace negative input analog comparator trigger source adate set bit determine trigger source free running mode trigger analog comparator us external interrupt request remaining value set various source embedded controller multiplexer selection register used reference selection data justification bit description follow reference voltage yield aref pin yield avcc yield internal volt reference reserved left adjust result setting bit left justify output bit register setting zero right justifies multiplexer bit select input pin selects selects selecting temperature sensor selects volt reference selects ground value reserved finally adch adcl adc high low output register register bit converter register hold bit mode operation conjunction adlar bit admux register adlar set bit placed adch bit placed adcl adlar cleared bit adcl bit adch just think register single bit register bit pushed left right shown figure adch adcl adlarbit adc figure data justification bit resolution needed possible left justify read just adch ignoring adcl single conversion operation fairly straightforward set initialization section begin setting aden enable decide proper prescale value chip specification indicate successive approximation circuitry perform best adc clock range khz khz typical conversion adc clock cycle conversion initialization overhead determined set adlar data justification ref reference voltage set admux bit determine input channel finally set adsc start conversion wait bit come later conversion complete hardware reset zero point read value adcl combine shift value read adch bit integer note read adcl reading adch reading adcl lock adc register preventing hardware overwriting register subsequent conversion reading adch unlocks closer look software process chapter embedded controller bit piece analogread introduction just like read state simple switch need read continuously variable analog data usually mean output voltage caused form sensor temperature sensor force sensor light sensor simple passive device cd cell fsrs placed resistive bridge network output voltage shift change environment simpler application use potentiometer hooked fixed voltage supply position pot controlled user represent setting conceivable parameter volume brightness time delay frequency order read analog quantity atmega contains single bit converter multiplexed input channel arduino uno board input adcs pin labeled arduino development environment contains useful function access thesis analogread analogreference function description repeated analogread description read value specified analog pin arduino board contains channel channel mini nano mega analog digital converter mean map input voltage volt integer value yield resolution reading volt unit volt mv unit input range resolution changed using analogreference take microsecond s read analog input maximum reading rate time second syntax analogread pin parameter pin number analog input pin read board mini nano mega return int note analog input pin connected value returned analogread fluctuate based number factor value analog input close hand board http embedded controller analog input pin analogreference description configures reference voltage used analog input value used input range option default analog reference volt arduino board volt arduino board reference equal volt volt available arduino mega reference arduino mega reference arduino mega voltage applied aref pin used reference syntax analogreference type parameter type type reference use default internal external return note changing analog reference reading analogread accurate warning use external reference voltage aref pin using external reference aref pin set analog reference external calling analogread short active reference voltage internally generated aref pin possibly damaging microcontroller arduino board alternatively connect external reference voltage aref pin resistor http embedded controller switch external internal reference voltage note resistor alter voltage get used reference internal resistor aref pin act voltage divider example applied resistor yield aref pin analog input pin figure analogread analogreference doc analogread function best used single conversion snapshot good simple user interface basic sensor application generally speaking analogreference called setup initialization phase program unless compelling reason default mode best place start yield volt peak peak input range bit resolution just millivolt important note range run volt volt volt volt depending amplitude frequency range sensor signal input processing circuitry required apply dc offset amplify reduce signal strength filter frequency extreme forth code analogreference simple get just set hide global variable accessed analogread function default void analogreference mode mode analogread function bit interesting actually bit interesting preceding chapter saw register associated adc single conversion operation important register include adcsra adc control status register admux adc multiplexer selection register register bit repeated convenience registerbit figure adc bit recall adch adcl register contain high low byte result respectively adcsra setting aden enables adc setting adsc start conversion stay embedded controller complete hardware resetting zero adif adie used mode discussed adate stand ad auto trigger enable allows triggering adc external signal discussed adpsx bit set conversion speed previous chapter detail admux refsx set reference voltage source use aref pin use vcc reserved use internal volt reference setting adlar bit word adch adcl result register leaving bit unused clearing bit leaf result right justified bit unused muxx bit select input channel used conversion example read channel set bit pattern register available adsrb acsr useful mode operation necessary current purpose code follows cleaned ease reading original code contains considerable number ifdefs work different microcontrollers int analogread pin low high pin pin allow channel pin number set analog reference input pin clear adlar admux pin start conversion sbi adcsra adsc adsc cleared conversion finish adcsra adsc read low high byte result low adcl high adch combine byte return high low figure analogread code embedded controller s closer look unsigned byte declared hold content high low result register pin argument translated note undocumented usage channel pin number cautious using undocumented feature low high pin pin allow channel pin number point reference set note global shifted refsx bit pin number anded safety ored admux note result adlar set admux pin conversion initiated setting ad start conversion bit sbi macro reduces single set bit instruction assembly wait adsc bit cleared signifies conversion complete loop referred properly loop code simply sits bit checking finally cleared cause loop exit macro return true bit test set false s clear start conversion sbi adcsra adsc adsc cleared conversion finish adcsra adsc conversion complete adcl read doing lock adcl adch register adch read doing reverse result spurious value byte combined single bit integer result oring low byte high byte data result register bit zero returned integer resulting output range low adcl high adch combine byte return high low given default prescaler value function overhead maximum conversion rate approximately khz perfectly acceptable wide variety us function fairly bone straightforward use use function guide wish produce data set adlar bit simple modification time essence machine cycle wasted loop seen version version better choice practical example mapping sensor mentioned outset analog input used obtain data variety sensor potential issue range sensor output voltage conveniently line adc input range requiring form data scaling offsetting input voltage embedded controller mapped range desired numeric output value hardware time simple mathematical process suffice example suppose sensor ll use measuring temperature liquid water standard pressure specification indicate unit produce volt freezing degree fahrenheit volt boiling degree fahrenheit assuming using default reference yield input range zero volt ll using available dynamic range volt make use bit adc d need run sensor signal conditioning circuit map volt output range volt input range require amplifier level shift volt voltage gain subtract volt sensor output multiply result doing degree output volt produce zero volt degree output volt produce volt modest op amp discrete transistor stage designed achieve adc input total range degree divided level yielding resolution better degree step note numeric value adc temperature value temperature degree yield adc output zero degree produce adc need display fahrenheit temperature multiplexed seven segment lcd display ll need map simple formula ll look moment arduino map function modest resolution tolerated simple software mapping used sensor output accept ll getting available resolution example degree resolution assuming sufficient numeric readout just mentioned need map input voltage volt numeric output input volt numeric output volt input represents adc s maximum input signal produce value approximately volt input produce approximately represents offset degree range need represent temperature range degree small formula av value returned analogread dv value displayed dv note computation entirely integer math floating point best possible speed minimal compiled code large value variable av product overflow unsigned int long computation needed note multiply integer divide horrendous loss precision occur truncation dv short unsigned char little creative casting yield like dv short long using integer displayed temperature resolution degree truncating exercise using sensor produce volt freezing volt boiling circuit scale sensor output volt input range code required display associated value celsius volt display volt display embedded controller bit piece analogwrite advanced microcontrollers contain digital analog converter dac produce continuously variable analog output signal atmega uno don t controller produce analog signal method use entire bank port pin say bit port b feed directly external dac write byte port desired rate dac reconstruction filter reconstructs data smooth signal second method relies pulse width modulation scheme employed uno arduino board note load operate properly simple pwm signal load require processing pwm signal filtering key understanding pulse width modulation consider area curve suppose volt pulse signal last period second go low second repeat area achieved volt pulse stayed high just second average value pulse course second half volt similarly volt pulse stayed high second course second period average value volt word greater duty cycle higher average voltage level sped pulse millisecond microsecond width repeated low pas filter pulse train achieve smoothly varying result load wouldn t filter result example include driving resistive heating element control temperature driving led control brightness uno achieves pwm use internal counter b component s possible generate pwm signal arduino tell pin just looking board pwm pin tilde arduino pin number analogwrite function take great deal work shoulder documentation repeated convenience analogwrite description writes analog value pwm wave pin used light led varying brightness drive motor various speed analogwrite pin generate steady square wave specified duty cycle analogwrite digitalread digitalwrite pin frequency pwm signal approximately hz arduino board function work pin arduino mega work pin older arduino board support analogwrite pin arduino support analogwrite pin plus pin unlike pwm pin digital analog converter act true analog output need pinmode set pin output calling analogwrite http embedded controller analogwrite function analog pin analogread function syntax analogwrite pin value parameter pin pin write value duty cycle return note known issue pwm output generated pin duty cycle interaction millis delay function share internal timer used generate pwm output noticed low setting result value fully turning output pin pwm figure analogwrite doc line analogwrite just pin duty cycle value range fully s range instead obvious percent let s look code usual slightly cleaned convenience original code file void analogwrite pin int val pinmode pin output val digitalwrite pin low val digitalwrite pin high embedded controller digitalpintotimer pin case connect pwm pin timer channel sbi val set pwm duty break case connect pwm pin timer channel b sbi val set pwm duty break case default val digitalwrite pin low digitalwrite pin high figure analogwrite code thing pinmode guarantee pin set output s possible simply require programmer make function usage safer place inside function note using pin mode make just setup routine make version analogwrite having removed section shave execution time pinmode pin output code doe quick check want fully fully case dispenses timer just call digitalwrite val digitalwrite pin low embedded controller val digitalwrite pin high point value entered pin translated timer statement appropriate timer s control register activated duty cycle value loaded associated count register timer bit unit hold value duty cycle value run instead percent technically timer bit unit used switch digitalpintotimer pin case connect pwm pin timer channel sbi val set pwm duty break case connect pwm pin timer channel b sbi val set pwm duty break finally analogwrite used pin configured timer function doe best calling digitalwrite value half produce low value half produce high case default val digitalwrite pin low digitalwrite pin high worth repeating arduino board contain internal dac function produce true analog output signal code shown embedded controller bit piece introduction virtually microcontrollers contain hardware function block used variety function including generating time delay counting input event generating simple pulse pwm waveform triggering software interrupt general multiple way configure block set simple counter clocked clock instance run asynchronously external clock source atmega contains block bit unit named timer counter bit unit functional block diagram bit unit shown figure bit unit similar offer extended ability figure functional block diagram bit embedded controller couple register used program operation block tccrna tccrnb timer counter control register b n number microcontrollers series bit usually set forget given use touched unless unit need reprogrammed different use presented momentarily register used software interrupt tifrn timskn timer interrupt flag register timer interrupt mask register aren t shown examine section software interrupt key register tcntx timer count ocrna ocrnb output compare register b basic operation unit increment tcntn register tick clock eventually register reach maximum value overflow resulting zero effectively resetting register count continues maximum value bit unit binary bit unit optionally unit programmed inspect value contained ocrn register compare current content tcntn match overflow compare match used trigger action waveform level change software interrupt compare match section feed pulse waveform generator turn feed output pin section shown figure figure compare match output circuitry embedded controller box marked ocnx pin physical pin microcontroller impractical single purpose pin function microcontroller waveform function mapped general purpose io pin compare section gpio block diagram discussed chapter note port ddr particular waveform generator feed flip flop feed multiplexer port flip flop signal fed buffer controlled ddr lead physical output pin compare match register total physical output pin available waveform generation mapping assignment shown figure arduino pin figure waveform pin assignment following discussion focus number unit zero used common arduino call delay reprogramming alter operation function procedure number little safer experiment regard aware unit used cover pwm capable output pin uno analogwrite control register indicate mode operation register shown figure unit number control register unit similar detail appendix figure register atmel figure register atmel embedded controller item c bit clock prescale bit allow longer timer period dividing clock feed counter example controller running mhz clock tick represents mhz nanosecond counting yield maximum delay nanosecond time microsecond prescaler set tick stretched factor yielding maximum delay microsecond example prescaler setting shown figure stopped prescale figure prescaler setting turning waveform generation mode wgm bit normal mode compare mode ctc clear timer compare form pulse width modulation examine normal fast pwm mode ctc mode chapter covering interrupt note wgm bit spread control register residing single register wgm bit detailed figure mode normal correct pwm ctc pwm reserved correct pwm reserved pwm figure waveform generation mode bit finally let s consider compare output mode com bit bit setting similar identical detail atmel embedded controller setting figure waveform generation mode output pin signal responds note mode com bit clear output pin disconnected operates ordinary io form setting com bit controlled waveform generator important note associated ddr set output mode order waveform reach output pin examine block diagram figure verification description disconnected compare match compare match compare match figure compare output mode description normal disconnected normal disconnected toggle compare match reserved operation compare match set mode compare match clear inverting mode figure fast pwm compare output mode description normal disconnected normal disconnected toggle compare match reserved operation compare match set compare match set figure phase correct pwm compare output mode embedded controller normal mode normal mode clear simplest mode operation tc simply count overflow wrap zero overflow flag timer overflow set flag register precisely bit set clock cycle register zero access restriction code overwrite content register time order alter counting behavior short code example follows program us create time delay similar delay function delay used blink led connected simple led blinker using create time delay active high led connected define ledmask define countoffset void setup ddrb ledmask normal mode prescale void mydelay int x x overflow clear flag bit set overflow wait overflow bit x void loop portb ledmask mydelay portb mydelay setup function set direction led driver pin output place normal mode set clock prescaler mean count occur rate just slower khz given mhz clock uno mydelay function initializes counter s main register predefined value countoffset count point overflow set flag ensure bit clear continuing using seemingly backward command appears command set flag bit doe clear verified atmel documentation point bit waiting set example count overflow millisecond embedded controller iterated x time achieve longer variable delay note larger value countoffset yield shorter blink time fast pwm mode fast pulse width modulation mode drive output pin directly fast pwm faster phase correct pwm fast pwm performs single slope count phase correct pwm us dual slope counting technique examine phase correct pwm use fast pwm mode drive output pin remember set corresponding ddr bit output mode figure following wgm com bit need set according figure desired prescaler c bit figure finally value output compare register need set value register determine duty cycle resulting pulse waveform basically count normal fashion overflowing recycling usual content match associated output compare register corresponding output pin change appropriate state duty cycle defined total count range compare register value plus example seen waveform external pin fast pwm mode void setup enable output driver ddrb ddrd following step clarity specify fast pwm add output prescale set duty cycle void loop interesting new twist main loop function set run attention truly set forget operation case output frequency main clock mhz divided prescaler divided total count yield approximately hz duty cycle output output b result approximately embedded controller preceding code downloaded arduino uno oscilloscope attached output pin resulting waveform shown figure note relative accuracy timing computation compared measured oscilloscope worthwhile note value output compare register changed programmatically example potentiometer connected analog input pin effectively recreate alternate form analogwrite function figure fast pwm output waveform embedded controller bit piece interrupt introduction interrupt thought small snippet code high priority main program flow momentarily halted interrupt code run interrupt code referred interrupt service routine isr finished main code pick left dealing interrupt mind happen time middle line c code fact single line c generate line native machine code interrupt occur machine code instruction interrupt usually come source externally triggered event physical pin changing state internally triggered event example external switch used force program reset start alternately overflow compare match event internal used create internal interrupt control timing event interrupt occurs current state location executing code saved microcontroller jump starting address isr isr code executed completion program flow reverts left main sequence main program flow halted temporarily isrs designed short execute quickly minimal timing impact main code microcontrollers numerous source interrupt interrupt usually prioritized important mean possible interrupt interrupt interrupt nested interrupt having different priority way like alarm sensor precedence mundane sensor input volume control quite possible complicated application dozen possible interrupt source isr starting location isrs vector table vector table basically array pointer case pointer point starting address code address variable programmer use word vector verb code flow vector isr simplify programming name isrs predetermined programmer simply need code isr simple setting global variable program compiled predetermined noted code expanded vector table automatically generally speaking isrs argument need create function prototype list isr name atmega series shown figure list taken directly hardware profile file note isr end portion indicates hardware associated quick scan list reveal number hardware element covered earlier analog digital converter finally interrupt used desired interrupt enabled setting appropriate bit associated register eimsk external interrupt mask timskx timer interrupt maskx appendix following example detail course global interrupt enable set accomplished sei case arduino embedded controller interrupt vector reset vector define external interrupt request define external interrupt request define pin change interrupt request define pin change interrupt request define pin change interrupt request define watchdog interrupt define compare match define compare match b define overflow define capture event define compare match define compare match b define overflow define compare match define compare match b define overflow define spi serial transfer complete define usart rx complete define usart data register define usart tx complete define adc conversion complete define eeprom ready define analog comparator define serial interface define store program memory read figure isr vector table name external interrupt let s consider external interrupt case state change seen external pin cause interrupt use external interrupt request known vector interrupt examines state change uno pin example fairly simple attach passive switch using internal pin switch activated toggle led connected uno pin code follows external interrupt example external interrupt pin light led active high led attached switch uno pin falling edge trigger external pin interrupt isr toggle led define ledmask void setup ddrb ledmask embedded controller set uno pin input ddrd portd eimsk enable external interrupt uno pin eicra trigger falling edge isr portb ledmask toggle led void loop setting io pin code set bit eimsk register enable interrupt external interrupt control register eicra programmed trigger falling negative going edge switch activated falling edge trigger isr run isr simply toggle bit led tied note port setting pin examination main code fact loop doe thing external interrupt useful high importance item panic switch internal interrupt blinking led section shall examine series example using interrupt trigger internal technique make use overflow compare match event usually used wish event occur predictable time penalty limitation using simple delay style approach trigger event need attention main program loop generally set forget variety timer interrupt mask register counter appropriate bit s set enable desired interrupt example show simple method blinking led hand duty cycle blink possible alter example show generate long time interval bit use global variable example shown interrupt example show blink led hand using overflow show large timing value bit counter normal count mode volatile int define ledmask embedded controller define void setup ddrb ledmask normal mode pin disconnected prescale enable overflow interrupt isr portb ledmask void loop used normal mode meaning count overflow repeat prescaler set producing tick khz overflow interrupt counter enabled trigger count create overflow rate slightly hz mean led single cycle rate second little fast naked eye t simply toggle led appear instead make use global variable track time interrupt occurred hit predetermined maximum reset led toggled blinking led completely hand far main code flow concerned note loop continue case remaining example internal interrupt hand wrought pwm example show overflow used create pwm signal arbitrary pin just ocnx pin example shall forego use led indicator simply inspect signal oscilloscope output frequency slightly hz duty cycle set define just easily set variable duty cycle value yield approximately value yield nearly output pin set uno pin code follows interrupt example show create hand wrought pwm arbitrary pin embedded controller define arbpinmask define void setup ddrb arbpinmask normal mode pin disconnected prescale enable overflow interrupt init counter count isr portb arbpinmask portb arbpinmask void loop code similar prior example addition alteration count register interrupt cause pin toggle unlike previous example count register set new starting value shortens count time time overflow reset value dependent current output level high low internal interrupt ctc mode example involves toggling arbitrary output pin ocnx pin piggybacked desired instead pwm example varies frequency square wave using clear timer compare ctc mode mode simply count value stored output compare match register reset zero interrupt example us ctc mode clear timer compare define arbpinmask define void setup ddrb arbpinmask embedded controller enable output driver piggyback ddrb non pwm pin toggle compare match add ctc mode prescale enable compare match interrupt isr portb arbpinmask void loop note new bit set interrupt mask register output compare interrupt enable unit output compare register set fixed value set variable value yield square wave frequency slightly hz halving value roughly double frequency hz embedded controller atmega register map derived october version atmel documentation http addressnamebit general purpose register eeprom data register eeprom address register low byte eeprom address register high byte output compare register output compare register b general purpose register general purpose register spi data register embedded controller wdrfborfextrfporf ivcelivce oscillator calibration register adc data register low byte adc data register high byte counter register low byte counter register high byte input capture register low byte input capture register high byte embedded controller output compare register low byte output compare register high byte output compare register b low byte output compare register b high byte output compare register output compare register b serial interface bit rate register serial interface data register usart data register usart baud rate register high usart baud rate register low embedded controller b answer selected problem chapter ralph johnson june ralph johnson june include int main void printf ralph johnson chapter printf result f volt int x x sizeof y w b c d chapter x printf negative value assumes variable integer x y printf d x printf d y printf error embedded controller r chapter float fptr c unsigned character bit byte variable p pointer unsigned character meaning contains address variable unsigned character c p byte size depending operating address operator return address associated variable dereferencing operator return value memory address referenced associated variable multiplies b value referenced c c pointer clear pointer dereference explicitly b c chapter structure definition struct quest float x long y unsigned char z declaration instance struct quest grail chapter char x x malloc free x free f embedded controller adc arduino home arm coretex ascii auto class variable biscotti bitwise operator boolean bus byte c compiler free cast char keyword cisc const keyword ctc mode dac ddr data direction register debounce double float keyword dram dynamic ram eeprom extern keyword float keyword global declaration global interrupt enable gpio harvard architecture header file hex hexadecimal include file header file int keyword long short isr interrupt service routine led embedded controller boolean operator long keyword table lsb significant bit macro marmot msb significant bit mux multiplex overflow pin port piranha brother pointer potentiometer printf resistor pwm python range numeric type register keyword risc switch scanf schmitt trigger short keyword sizeof sram static ram static keyword status register string function buffer vector table volatile keyword v neumann architecture waveform woodchuck marmot z high impedance state buffer embedded controller