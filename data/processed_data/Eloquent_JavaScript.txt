EloquentJavaScript 4thedition Marijn Haverbeke Copyright © 2024 by Marijn Haverbeke This work is licensed under a Creative Commons attribution-noncommercial license ( http://creativecommons.org/licenses/by-nc/3.0/ ). All code in the bookmayalsobeconsideredlicensedunderanMITlicense( https://eloquentjavascript. net/code/LICENSE ). The illustrations are contributed by various artists: Cover by Péchane Sumie. Chapter illustrations by Madalina Tantareanu. Pixel art in Chapters 7 and 16 by Antonio Perdomo Pastor. Regular expression diagrams in Chapter 9 generated with regexper.com by Jeff Avallone. Game concept for Chapter 16 byThomas Palef . You can buy a print version of this book, with an extra bonus chapter included, printed by No Starch Press at http://a-fwd.com/com=marijhaver-20&asincom=1593279507 . i Contents Introduction 1 On programming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2 Why language matters . . . . . . . . . . . . . . . . . . . . . . . . . . . 3 What is JavaScript? . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 5 Code, and what to do with it . . . . . . . . . . . . . . . . . . . . . . . 7 Overview of this book . . . . . . . . . . . . . . . . . . . . . . . . . . . . 8 Typographic conventions . . . . . . . . . . . . . . . . . . . . . . . . . . 8 1 Values,Types,andOperators 10 Values. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 10 Numbers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 11 Strings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 13 Unary operators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15 Boolean values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 15 Empty values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 17 Automatic type conversion . . . . . . . . . . . . . . . . . . . . . . . . . 18 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 20 2 ProgramStructure 21 Expressions and statements . . . . . . . . . . . . . . . . . . . . . . . . 21 Bindings . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 22 Binding names . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24 The environment . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24 Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 24 The console.log function . . . . . . . . . . . . . . . . . . . . . . . . . . 25 Return values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 25 Control flow . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26 Conditional execution . . . . . . . . . . . . . . . . . . . . . . . . . . . . 26 while and do loops . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 28 Indenting Code . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 30 for loops . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 31 Breaking Out of a Loop . . . . . . . . . . . . . . . . . . . . . . . . . . 32 ii Updating bindings succinctly . . . . . . . . . . . . . . . . . . . . . . . 32 Dispatching on a value with switch . . . . . . . . . . . . . . . . . . . . 33 Capitalization . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34 Comments . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 34 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 35 3 Functions 38 Defining a function . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 38 Bindings and scopes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 39 Nested scope . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 40 Functions as values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 41 Declaration notation . . . . . . . . . . . . . . . . . . . . . . . . . . . . 42 Arrow functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 42 The call stack . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 43 Optional Arguments . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 44 Closure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 45 Recursion . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 47 Growing functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 50 Functions and side effects . . . . . . . . . . . . . . . . . . . . . . . . . 52 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 53 4 DataStructures:ObjectsandArrays 55 The weresquirrel . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 55 Datasets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 56 Properties . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 57 Methods . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 57 Objects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 58 Mutability . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 61 The lycanthrope’s log . . . . . . . . . . . . . . . . . . . . . . . . . . . . 62 Computing correlation . . . . . . . . . . . . . . . . . . . . . . . . . . . 64 Array loops . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 65 The final analysis . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 66 Further arrayology . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 68 Strings and their properties . . . . . . . . . . . . . . . . . . . . . . . . 69 Rest parameters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 71 The Math object . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 72 Destructuring . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 73 Optional property access . . . . . . . . . . . . . . . . . . . . . . . . . . 74 iii JSON. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 75 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 76 5 Higher-OrderFunctions 79 Abstraction . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 80 Abstracting repetition . . . . . . . . . . . . . . . . . . . . . . . . . . . 80 Higher-order functions . . . . . . . . . . . . . . . . . . . . . . . . . . . 82 Script dataset . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 83 Filtering arrays . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 84 Transforming with map . . . . . . . . . . . . . . . . . . . . . . . . . . . 85 Summarizing with reduce . . . . . . . . . . . . . . . . . . . . . . . . . . 85 Composability . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 86 Strings and character codes . . . . . . . . . . . . . . . . . . . . . . . . 88 Recognizing text . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 91 6 TheSecretLifeofObjects 93 Abstract Data Types . . . . . . . . . . . . . . . . . . . . . . . . . . . . 93 Methods . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 94 Prototypes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 95 Classes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 97 Private Properties . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 99 Overriding derived properties . . . . . . . . . . . . . . . . . . . . . . . 100 Maps. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 101 Polymorphism . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 102 Getters, setters, and statics . . . . . . . . . . . . . . . . . . . . . . . . 103 Symbols . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 105 The iterator interface . . . . . . . . . . . . . . . . . . . . . . . . . . . . 106 Inheritance . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 108 The instanceof operator . . . . . . . . . . . . . . . . . . . . . . . . . . . 109 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 110 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 111 7 Project:ARobot 112 Meadowfield . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 112 The task . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 114 Persistent data . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 116 Simulation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 116 iv The mail truck’s route . . . . . . . . . . . . . . . . . . . . . . . . . . . 118 Pathfinding . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 119 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 121 8 BugsandErrors 123 Language . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 123 Strict mode . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 124 Types. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 125 Testing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 126 Debugging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 127 Error propagation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 128 Exceptions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 130 Cleaning up after exceptions . . . . . . . . . . . . . . . . . . . . . . . . 131 Selective catching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 133 Assertions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 135 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 136 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 136 9 RegularExpressions 138 Creating a regular expression . . . . . . . . . . . . . . . . . . . . . . . 138 Testing for matches . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 139 Sets of characters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 139 International characters . . . . . . . . . . . . . . . . . . . . . . . . . . . 140 Repeating parts of a pattern . . . . . . . . . . . . . . . . . . . . . . . . 142 Grouping subexpressions . . . . . . . . . . . . . . . . . . . . . . . . . . 143 Matches and groups . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 143 The Date class . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 144 Boundaries and look-ahead . . . . . . . . . . . . . . . . . . . . . . . . . 145 Choice patterns . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 146 The mechanics of matching . . . . . . . . . . . . . . . . . . . . . . . . 147 Backtracking . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 147 The replace method . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 149 Greed. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 150 Dynamically creating RegExp objects . . . . . . . . . . . . . . . . . . 152 The search method . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 152 The lastIndex property . . . . . . . . . . . . . . . . . . . . . . . . . . . 153 Parsing an INI file . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 154 Code units and characters . . . . . . . . . . . . . . . . . . . . . . . . . 157 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 157 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 159 v 10 Modules 161 Modular programs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 161 ES modules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 162 Packages . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 164 CommonJS modules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 165 Building and bundling . . . . . . . . . . . . . . . . . . . . . . . . . . . 168 Module design . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 169 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 171 11 AsynchronousProgramming 173 Asynchronicity . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 173 Callbacks . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 175 Promises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 176 Failure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 178 Carla. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 180 Breaking In . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 181 Async functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 182 Generators . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 184 A Corvid Art Project . . . . . . . . . . . . . . . . . . . . . . . . . . . . 185 The event loop . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 188 Asynchronous bugs . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 189 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 191 12 Project:AProgrammingLanguage 193 Parsing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 193 The evaluator . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 197 Special forms . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 199 The environment . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 200 Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 202 Compilation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203 Cheating . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 203 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 204 13 JavaScriptandtheBrowser 206 Networks and the Internet . . . . . . . . . . . . . . . . . . . . . . . . . 206 The Web . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 208 HTML . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 208 HTML and JavaScript . . . . . . . . . . . . . . . . . . . . . . . . . . . 211 vi In the sandbox . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 212 Compatibility and the browser wars . . . . . . . . . . . . . . . . . . . 212 14 TheDocumentObjectModel 214 Document structure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 214 Trees. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 215 The standard . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 216 Moving through the tree . . . . . . . . . . . . . . . . . . . . . . . . . . 217 Finding elements . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 218 Changing the document . . . . . . . . . . . . . . . . . . . . . . . . . . 219 Creating nodes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 220 Attributes . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 222 Layout . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 222 Styling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 224 Cascading styles . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 226 Query selectors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 227 Positioning and animating . . . . . . . . . . . . . . . . . . . . . . . . . 228 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230 15 HandlingEvents 233 Event handlers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 233 Events and DOM nodes . . . . . . . . . . . . . . . . . . . . . . . . . . 234 Event objects . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235 Propagation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 235 Default actions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 237 Key events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 237 Pointer events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 239 Scroll events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 243 Focus events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 244 Load event . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 245 Events and the event loop . . . . . . . . . . . . . . . . . . . . . . . . . 245 Timers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 246 Debouncing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 247 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 248 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 249 16 Project:APlatformGame 251 The game . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 251 The technology . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252 vii Levels. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 252 Reading a level . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 253 Actors. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 255 Drawing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 258 Motion and collision . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 263 Actor updates . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 266 Tracking keys . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 268 Running the game . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 269 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 271 17 DrawingonCanvas 273 SVG. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 273 The canvas element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 274 Lines and surfaces . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 275 Paths. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 276 Curves . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 277 Drawing a pie chart . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 280 Text. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 281 Images . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 282 Transformation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 283 Storing and clearing transformations . . . . . . . . . . . . . . . . . . . 286 Back to the game . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 287 Choosing a graphics interface . . . . . . . . . . . . . . . . . . . . . . . 292 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 293 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 294 18 HTTPandForms 296 The protocol . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 296 Browsers and HTTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . 298 Fetch. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 299 HTTP sandboxing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301 Appreciating HTTP . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 301 Security and HTTPS . . . . . . . . . . . . . . . . . . . . . . . . . . . . 302 Form fields . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 303 Focus. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 304 Disabled fields . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 305 The form as a whole . . . . . . . . . . . . . . . . . . . . . . . . . . . . 306 Text fields . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 307 Checkboxes and radio buttons . . . . . . . . . . . . . . . . . . . . . . . 309 Select fields . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 310 viii File fields . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 311 Storing data client-side . . . . . . . . . . . . . . . . . . . . . . . . . . . 312 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 315 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 315 19 Project:APixelArtEditor 318 Components . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 318 The state . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 320 DOM building . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 321 The canvas . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 322 The application . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 325 Drawing tools . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 327 Saving and loading . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 330 Undo history . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 333 Let’s draw . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 334 Why is this so hard? . . . . . . . . . . . . . . . . . . . . . . . . . . . . 335 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 336 20Node.js 338 Background . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 338 The node command . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 339 Modules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 340 Installing with NPM . . . . . . . . . . . . . . . . . . . . . . . . . . . . 341 The filesystem module . . . . . . . . . . . . . . . . . . . . . . . . . . . 343 The HTTP module . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 344 Streams . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 346 A file server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 347 Summary . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 352 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 353 21 Project:Skill-SharingWebsite 355 Design. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 355 Long polling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 356 HTTP interface . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 357 The server . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 359 The client . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 366 Exercises . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 372 ExerciseHints 374 Program Structure . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 374 ix Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 375 Data Structures: Objects and Arrays . . . . . . . . . . . . . . . . . . . 376 Higher-Order Functions . . . . . . . . . . . . . . . . . . . . . . . . . . . 378 The Secret Life of Objects . . . . . . . . . . . . . . . . . . . . . . . . . 379 Project: A Robot . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 380 Bugs and Errors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 381 Regular Expressions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 381 Modules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 382 Asynchronous Programming . . . . . . . . . . . . . . . . . . . . . . . . 383 Project: A Programming Language . . . . . . . . . . . . . . . . . . . . 385 The Document Object Model . . . . . . . . . . . . . . . . . . . . . . . 386 Handling Events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 387 Project: A Platform Game . . . . . . . . . . . . . . . . . . . . . . . . . 388 Drawing on Canvas . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 389 HTTP and Forms . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 391 Project: A Pixel Art Editor . . . . . . . . . . . . . . . . . . . . . . . . 392 Node.js . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 394 Project: Skill-Sharing Website . . . . . . . . . . . . . . . . . . . . . . . 395 x “W e think we are creating the system for our own purposes. W e believe we are making it in our own image... But the computer is not real ly like us. It is a projection of a very slim part of ourselves: that portion devoted to logic, order, rule, and clarity. ” —Ellen Ullman, Close to the Machine: Technophilia and Its Discontents Introduction This is a book about instructing computers. Computers are about as common as screwdrivers today, but they are quite a bit more complex, and making them do what you want them to do isn’t always easy. If the task you have for your computer is a common, well-understood one, such as showing you your email or acting like a calculator, you can open the appropriate application and get to work. But for unique or open-ended tasks, there often is no appropriate application. That is where programming may come in. Programming is the act of constructinga program—asetofpreciseinstructionstellingacomputerwhattodo. Because computers are dumb, pedantic beasts, programming is fundamentally tedious and frustrating. Fortunately, if you can get over that fact—and maybe even enjoy the rigor of thinking in terms that dumb machines can deal with—programming can be rewarding. It allows you to do things in seconds that would take foreverby hand. It is a way to make your computer tool do things that it couldn’t do before. On top of that, it makes for a wonderful game of puzzle solving and abstract thinking. Most programming is done with programming languages. A programming language is an artificially constructed language used to instruct computers. It is interesting that the most effective way we’ve found to communicate with a computer borrows so heavily from the way we communicate with each other. Like human languages, computer languages allow words and phrases to be combined in new ways, making it possible to express ever new concepts. Atonepoint,language-basedinterfaces,suchastheBASICandDOSprompts of the 1980s and 1990s, were the main method of interacting with computers. For routine computer use, these have largely been replaced with visual interfaces, which are easier to learn but offer less freedom. But if you know where to look, the languages are still there. One of them, JavaScript , is built into every modern web browser—and is thus available on almost every device. This book will try to make you familiar enough with this language to do useful and amusing things with it. Onprogramming Besides explaining JavaScript, I will introduce the basic principles of programming. Programming, it turns out, is hard. The fundamental rules are simple and clear, but programs built on top of these rules tend to become complex enough to introduce their own rules and complexity. You’re building your own maze, in a way, and you can easily get lost in it. There will be times when reading this book feels terribly frustrating. If you are new to programming, there will be a lot of new material to digest. Much of this material will then be combined in ways that require you to make additional connections. It is up to you to make the necessary effort. When you are struggling to follow the book, do not jump to any conclusions about your own capabilities. You are fine—you just need to keep at it. Take a break, reread some material, and make sure you read and understand the example programs and exercises. Learning is hard work, but everything you learn is yours and will make further learning easier. When action grows unprofitable, gather information; when information grows unprofitable, sleep. —Ursula K. Le Guin, The Left Hand of Darkness A program is many things. It is a piece of text typed by a programmer, it is the directing force that makes the computer do what it does, it is data in the computer’s memory, and, at the same time, it controls the actions performed on this memory. Analogies that try to compare programs to familiar objects tend to fall short. A superficially fitting one is to compare a program to a machine—lots of separate parts tend to be involved, and to make the whole thing tick, we have to consider the ways in which these parts interconnect and contribute to the operation of the whole. A computer is a physical machine that acts as a host for these immaterial machines. Computers themselves can do only stupidly straightforward things. The reason they are so useful is that they do these things at an incredibly high speed. A program can ingeniously combine an enormous number of these simple actions to do very complicated things. A program is a building of thought. It is costless to build, it is weightless, and it grows easily under our typing hands. But as a program grows, so does its complexity. The skill of programming is the skill of building programs that don’t confuse the programmer. The best programs are those that manage to do something interesting while still being easy to understand. Some programmers believe that this complexity is best managed by using only a small set of well-understood techniques in their programs. They have composed strict rules (“best practices”) prescribing the form programs should have and carefully stay within their safe little zone. This is not only boring—